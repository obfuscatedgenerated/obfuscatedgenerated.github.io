"use strict";(self.webpackChunkollieos=self.webpackChunkollieos||[]).push([[485],{976:(e,t,r)=>{r.d(t,{boot_os:()=>hr});var i={};r.r(i),r.d(i,{alias:()=>Gt,ascmagine:()=>Se,ash:()=>te,bugreport:()=>Ie,cat:()=>me,cd:()=>_e,clear:()=>oe,default_privilege_agent:()=>re,echo:()=>le,edit:()=>he,fsedit:()=>De,help:()=>se,hex:()=>pe,ignition:()=>G,imagine:()=>xe,ipc_bg_test:()=>tr,ipc_fg_test:()=>rr,jetty:()=>U,kill:()=>Ht,legacy:()=>Ne,ls:()=>de,mefetch:()=>ve,mkdir:()=>bt,mv:()=>vt,pkg:()=>yt,ps:()=>Wt,pwd:()=>ue,reader:()=>ke,recovery:()=>ie,repo:()=>Oe,rm:()=>Ae,rss:()=>je,selfdestruct:()=>Ee,shutdown:()=>ae,spark:()=>er,tb_test:()=>ir,touch:()=>$t,tour:()=>Ge,trigger_create_trigger:()=>nr,trigger_remove_trigger:()=>sr,unalias:()=>Ut,unset:()=>ce,webget:()=>ge,window:()=>Yt});var n=r(616),s=r(832),a=r(292),o=r(856);const l="\r\n",c=/[\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g,d=/(\\u001b|\\x1b)(8|7|H|>|\[(\?\d+(h|l)|[0-2]?(K|J)|\d*(A|B|C|D\D|E|F|G|g|i|m|n|S|s|T|u)|1000D\d+|\d*;\d*(f|H|r|m)|\d+;\d+;\d+m))/g,_=/(\u001b|\x1b)\[(\d+)?(;\d+)*m/g,u={reset:"[39m",black:"[30m",red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m",gray:"[90m"},w={reset_all:"[0m",bold:"[1m",dim:"[2m",no_bold_or_dim:"[22m",italic:"[3m",no_italic:"[23m",underline:"[4m",double_underline:"[21m",no_underline:"[24m",inverse:"[7m",no_inverse:"[27m",hidden:"[8m",no_hidden:"[28m",strikethrough:"[9m",no_strikethrough:"[29m",negative:"[7m",positive:"[27m"},h={invisible:"[?25l",visible:"[?25h"},g={FG:u,BG:{reset:"[49m",black:"[40m",red:"[41m",green:"[42m",yellow:"[44m",blue:"[44m",magenta:"[45m",cyan:"[46m",white:"[47m",gray:"[100m"},STYLE:w,CURSOR:h,PREFABS:{program_name:u.cyan+w.italic+w.bold,error:u.red+w.bold,variable_name:u.yellow+w.bold,file_path:u.green+w.bold,dir_name:u.blue+w.bold,secret:w.hidden+h.invisible}};class m extends o.Terminal{#e;#t=new Map;#r=[];#i=[];#n=!1;#s=!1;get ansi(){return g}get newline(){return l}get non_printable_regex(){return c}get ansi_escape_regex(){return d}get ansi_unescaped_regex(){return _}read_line=async(e={},t)=>{const r={current_line:"",current_index:0,set_current_line:e=>{r.current_line=e},set_current_index:e=>{r.current_index=e}};let i=null;return new Promise((n=>{const s={"[D":(e,t)=>{r.current_index>0&&(t.write("\b"),r.current_index--)},"[C":(e,t)=>{r.current_index<r.current_line.length&&(t.write(r.current_line[r.current_index]),r.current_index++)},"":(e,t)=>{if(r.current_line.length>0&&r.current_index>0){const e=r.current_line.slice(0,r.current_index-1),i=r.current_line.slice(r.current_index);r.current_line=e+i,t.write("\b"),t.write(i+" "),t.write("\b".repeat(i.length+1)),r.current_index--}},"\r":(e,t)=>{i&&i(),t.write(l),n(r.current_line)}};i=this.register_key_event_handler((async i=>{if(!(i.key in e)||!await e[i.key](i,this,r))if(i.key in s)await s[i.key](i,this);else if(null===i.key.match(c)){if(t&&await t(i,this,r))return;if(r.current_index===r.current_line.length)return r.current_line+=i.key,this.write(i.key),void r.current_index++;const e=r.current_line.slice(0,r.current_index),n=r.current_line.slice(r.current_index);r.current_line=e+i.key+n,this.write(i.key+n),this.write(`[${n.length}D`),r.current_index++}else console.warn("Ignored key event:",i)}),{block:!0,high_priority:!0})}))};_search_handlers=(e,t,r=!1)=>{for(const i of this.#t.entries()){const n=i[0];if(r){if(n.key===e&&n.domEventCode===t)return i[1]}else if(n.key===e||n.domEventCode===t)return i[1]}return[]};register_key_event_handler=(e,t)=>{const r={key:t.keyString,domEventCode:t.domEventCode},i={handler:e,block:t.block??!1},n=this._search_handlers(t.keyString,t.domEventCode,!0);return 0===n.length?this.#t.set(r,[i]):t.high_priority?n.unshift(i):n.push(i),()=>{const e=this.#t.get(r);e&&(e.splice(e.indexOf(i),1),0===e.length&&this.#t.delete(r))}};_handle_key_event=async e=>{const t=this._search_handlers(void 0,void 0,!0);if(t)for(const r of t)if(await r.handler(e,this),r.block)return;const r=this._search_handlers(e.key,e.domEvent.code);for(const t of r)if(await t.handler(e,this),t.block)return;if(null===e.key.match(c))for(const t of this.#r)await t(e,this)};register_on_printable_key_event_handler=(e,t=!1)=>{t?this.#r.unshift(e):this.#r.push(e)};_enqueue_key_event=e=>{this.#i.push(e),this.#n||(this.#n=!0,this._handle_key_event_queue())};_handle_key_event_queue=async()=>{0!==this.#i.length?this.#n&&(await this._handle_key_event(this.#i.shift()),this._handle_key_event_queue()):this.#n=!1};wait_for_keypress=async()=>(this.#e.dispose(),new Promise((e=>{this.#e=this.onKey((t=>{this.#e.dispose(),this.#e=this.onKey(this._enqueue_key_event),e(t)}))})));get_text=async e=>{let t="";return new Promise((r=>{const i=this.register_key_event_handler((n=>{"\r"===n.key?(i(),r(t)):""===n.key?t.length>0&&(t=t.slice(0,-1),this.write("\b \b")):null===n.key.match(c)&&(void 0===e||t.length<e)&&(t+=n.key,this.write(n.key))}),{block:!0,high_priority:!0})}))};word_wrap(e,t){const r=e.split(l),i=[];for(const e of r){const r=e.split(" ");let n="";for(const e of r)n.length+e.length+1>t?(i.push(n),n=e):0===n.length?n=e:n+=" "+e;i.push(n)}return i.join(l)}copy(){navigator.clipboard.writeText(this.getSelection()).then((()=>{this.clearSelection()}))}paste(){this.#s||navigator.clipboard.readText().then((e=>{for(const t of e){let e=`Key${t.toUpperCase()}`,r=t;"\r"!==t&&("\n"===t&&(r="\r",e="Enter")," "===t&&(e="Space"),this.#i.push({key:r,domEvent:{code:e}}))}this.#n||(this.#n=!0,this._handle_key_event_queue())}))}copy_or_paste(){this.hasSelection()?this.copy():this.paste()}handle_kernel_panic=(e,t,r)=>{this.#s||(this.#s=!0,this.reset(),this.#e.dispose(),this.write(g.CURSOR.invisible),this.textarea&&(this.textarea.disabled=!0),this.writeln(`${g.BG.red+g.FG.white}Panic: ${e}`),this.writeln(`at time: ${(new Date).toISOString()}`),this.write(l),this.writeln("Debug info:"),r?this.writeln(r):this.writeln("No debug info provided."),this.write(l),this.writeln("Processes running at time of panic:"),this.writeln(t||"None."),"undefined"!=typeof window&&(this.write(l),this.writeln("OS unrecoverable?"),this.writeln(`Visit ${window.location.origin}/recover_fs if stuck.`)),this.writeln(g.STYLE.reset_all))};constructor(e){super(e),this.#e=this.onKey(this._enqueue_key_event)}}const p=async(e,t=!1)=>{let r=!1;e.startsWith("import")&&(r=!0);const i=(e=>`data:text/javascript;charset=utf-8,${encodeURIComponent(e)}`)(e);let n=(await import(i)).default;if(void 0===n)throw r&&console.warn("Program has JS code starts with 'import'. Please update the package to use the new global externals system. This will be removed in the future."),new Error("Program is not the default export.");if("object"!=typeof n)throw r&&console.warn("Program has JS code starts with 'import'. Please update the package to use the new global externals system. This will be removed in the future."),new Error("Program is not an object.");if("string"!=typeof n.name)throw r&&console.warn("Program has JS code starts with 'import'. Please update the package to use the new global externals system. This will be removed in the future."),new Error("Program does not have a name.");if(r&&console.warn(`Program ${n.name} has JS code starts with 'import'. Please update the package to use the new global externals system. This will be removed in the future.`),globalThis.OLLIEOS_NODE&&n.node_opt_out)throw new Error(`Program ${n.name} is not compatible with Node.js.`);if("string"!=typeof n.description)throw new Error(`Program ${n.name} does not have a description.`);if("string"!=typeof n.usage_suffix)throw new Error(`Program ${n.name} does not have a usage suffix.`);if("object"!=typeof n.arg_descriptions)throw new Error(`Program ${n.name} does not have argument descriptions.`);if(!n.main){if(!n.async_main)throw new Error(`Program ${n.name} does not have a main function.`);console.warn(`Program ${n.name} has an async_main function. This is deprecated and will be removed in the future. Please use main instead.`),n.main=n.async_main,delete n.async_main}if(void 0!==n.main&&void 0!==n.async_main)throw new Error(`Program ${n.name} has both a main and async_main (deprecated) function.`);if(void 0!==n.main&&"AsyncFunction"!==n.main.constructor.name){console.warn(`Program ${n.name} has a main function that is not async. This is deprecated and will be removed in the future. Please make main async.`);const e=n.main;n.main=async t=>e(t)}return{program:n,built_in:t}},f=async e=>(await p(e)).program.name,y=async(e,t,r,i,n=!1)=>{const{PREFABS:s,FG:a,STYLE:o}=g;let l;try{l=await p(t)}catch(t){if(t.message.endsWith("is not compatible with Node.js."))return;return i.writeln(`${s.error}Failed to prepare program from '${e}'.${o.reset_all}`),i.writeln(`${s.error}${t}${o.reset_all}`),void i.writeln(`${s.error}Skipping mount...${o.reset_all}`)}try{await r.registerProgram(l),n&&i.writeln(`${a.cyan}(+) ${l.program.name}${o.reset_all}`)}catch(e){i.writeln(`${s.error}Failed to mount program '${l.program.name}'.${o.reset_all}`),i.writeln(`${s.error}${e}${o.reset_all}`),i.writeln(`${s.error}Skipping mount...${o.reset_all}`)}},$=async(e,t,r,i)=>{const n=await e.list_dir(t);for(const s of n){const n=e.join(t,s);if(await e.dir_exists(n))await $(e,n,r,i);else{if(!s.endsWith(".js"))continue;const t=await e.read_file(n);await y(s,t,r,i)}}};class b{#a=new Map;async registerProgram(e){const t=e.program;if(this.#a.has(t.name))throw new Error(`Program with name ${t.name} already exists.`);globalThis.OLLIEOS_NODE&&t.node_opt_out||this.#a.set(t.name,e)}getProgramRegistrant(e){return this.#a.get(e)}getProgram(e){const t=this.getProgramRegistrant(e);if(void 0!==t)return t.program}listProgramRegistrants(e=!0,t=!1){const r=Array.from(this.#a.values());return e&&t?r:e&&!t?r.filter((e=>e.built_in)):!e&&t?r.filter((e=>!e.built_in)):void 0}listProgramNames(e=!0,t=!1){const r=Array.from(this.#a.keys());return e&&t?r:e&&!t?r.filter((e=>this.getProgramRegistrant(e)?.built_in)):!e&&t?r.filter((e=>!this.getProgramRegistrant(e)?.built_in)):void 0}listPrograms(e=!0,t=!1){return this.listProgramRegistrants(e,t).map((e=>e.program))}async forceUnregister(e){this.#a.delete(e)}async unregister(e){if(!this.#a.has(e))throw new Error(`Program with name ${e} does not exist.`);await this.forceUnregister(e)}async build_registrant_from_js(e,t=!1){return p(e,t)}async determine_program_name_from_js(e){return f(e)}async mount_and_register_with_output(e,t,r,i=!1){return y(e,t,this,r,i)}async recurse_mount_and_register_with_output(e,t,r){return $(e,t,this,r)}create_userspace_proxy(e,t){const r=this,i=Object.create(null),n=async i=>{const n=r.getProgramRegistrant(i);if(n?.built_in)throw new Error(`Security Error: Built-in program '${i}' is protected and cannot be modified.`);if(i===e)throw new Error(`Security Error: The init system program '${i}' cannot be modified.`);let s="default_privilege_agent";try{s=(await t.read_file("/sys/privilege_agent")).trim()}catch{}if(s||(s="default_privilege_agent"),i===s)throw new Error(`Security Error: The privilege agent program '${i}' cannot be modified.`)};return Object.defineProperties(i,{getProgram:{value:e=>r.getProgram(e),enumerable:!0},listProgramNames:{value:(e,t)=>r.listProgramNames(e,t),enumerable:!0},registerProgram:{value:async e=>{if(e.built_in)throw new Error("Security Error: Cannot register built-in programs from userspace.");await n(e.program.name),await r.registerProgram(e)},enumerable:!0},unregister:{value:async e=>{await n(e),await r.unregister(e)},enumerable:!0},forceUnregister:{value:async e=>{await n(e),await r.forceUnregister(e)},enumerable:!0},build_registrant_from_js:{value:async(e,t=!1)=>r.build_registrant_from_js(e,t),enumerable:!0},determine_program_name_from_js:{value:async e=>r.determine_program_name_from_js(e),enumerable:!0},mount_and_register_with_output:{value:async(e,t,r,n=!1)=>y(e,t,i,r,n),enumerable:!0},recurse_mount_and_register_with_output:{value:async(e,r)=>$(t,e,i,r),enumerable:!0}}),Object.freeze(i)}}class v extends Error{constructor(e){super(`Path not found: ${e}`)}}class k extends Error{constructor(e){super(`Refusing to delete non-empty directory: ${e}`)}}class E extends Error{constructor(e){super(`Destination directory is not empty: ${e}`)}}class F extends Error{constructor(e){super(`Path is read-only: ${e}`)}}var x;!function(e){e[e.READING_FILE=0]="READING_FILE",e[e.WROTE_FILE=1]="WROTE_FILE",e[e.DELETED_FILE=2]="DELETED_FILE",e[e.MOVED_FILE=3]="MOVED_FILE",e[e.SET_READONLY=4]="SET_READONLY",e[e.LISTING_DIR=5]="LISTING_DIR",e[e.MADE_DIR=6]="MADE_DIR",e[e.DELETED_DIR=7]="DELETED_DIR",e[e.MOVED_DIR=8]="MOVED_DIR",e[e.SET_CWD=9]="SET_CWD",e[e.GETTING_CWD=10]="GETTING_CWD",e[e.SET_HOME=11]="SET_HOME",e[e.GETTING_HOME=12]="GETTING_HOME",e[e.SET_ROOT=13]="SET_ROOT",e[e.GETTING_ROOT=14]="GETTING_ROOT",e[e.CHECKING_EXISTS=15]="CHECKING_EXISTS",e[e.CHECKING_DIR_EXISTS=16]="CHECKING_DIR_EXISTS"}(x||(x={}));class S{_initialised=!1;#o=new Map;#l=new Map;_root="/";_home="/home";_cwd=this._home;purge_cache(e=!1){if(e)for(const e in this.#o)this.exists_direct(e)||this.#o.delete(e);else this.#o.clear()}force_remove_from_cache(e){this.#o.delete(e)}remote_purge_cache(e){localStorage.setItem("purge_cache",e.toString())}remote_remove_from_cache(e){localStorage.setItem("remove_from_cache",e)}#c(){const e=localStorage.getItem("purge_cache");e&&(this.purge_cache("true"===e),localStorage.removeItem("purge_cache"));const t=localStorage.getItem("remove_from_cache");t&&(this.force_remove_from_cache(t),localStorage.removeItem("remove_from_cache"))}register_callback(e,t){return this.#l.has(e)||this.#l.set(e,[]),this.#l.get(e).push(t),()=>{this.#l.get(e).splice(this.#l.get(e).indexOf(t),1)}}_call_callbacks(e,t){for(const r of this.#l.get(e)??[])r(t,this)}async read_file(e,t=!1){this._call_callbacks(x.READING_FILE,e);const r=this.#o.get(e);if(r&&await this.exists(e)&&r.as_uint===t)return this.#o.get(e).content;const i=await this.read_file_direct(e,t);return this.#o.set(e,{readonly:await this.is_readonly(e),content:i,as_uint:t}),i}async write_file(e,t,r=!1){let i=!1;if(await this.exists(e)&&(i=await this.is_readonly(e),!r&&i))throw new F(e);this.#o.set(e,{readonly:i,content:t,as_uint:t instanceof Uint8Array}),await this.write_file_direct(e,t),this._call_callbacks(x.WROTE_FILE,e)}async delete_file(e){this.#o.has(e)&&this.#o.delete(e),await this.delete_file_direct(e),this._call_callbacks(x.DELETED_FILE,e)}async move_file(e,t){this.#o.set(t,this.#o.get(e)),this.#o.delete(e),await this.move_file_direct(e,t),this._call_callbacks(x.MOVED_FILE,e)}async set_readonly(e,t){if(!await this.exists(e))throw new v(e);const r=this.#o.get(e);r?(r.readonly=t,this.#o.set(e,r)):this.#o.set(e,{readonly:t,content:await this.read_file(e),as_uint:!1}),await this.set_readonly_direct(e,t),this._call_callbacks(x.SET_READONLY,e)}async is_readonly(e){if(!await this.exists(e))throw new v(e);const t=this.#o.get(e);return t?t.readonly:this.is_readonly_direct(e)}async delete_dir(e,t=!1){await this.delete_dir_direct(e,t),this.purge_cache(!0)}async move_dir(e,t,r=!1){await this.move_dir_direct(e,t,r),this.purge_cache(!0)}get_cwd(){return this._call_callbacks(x.GETTING_CWD,this._cwd),this._cwd}set_cwd(e){e.endsWith("/")&&(e=e.slice(0,-1)),""===e&&(e=this._root),this._cwd=e,this._call_callbacks(x.SET_CWD,e)}get_home(){return this._call_callbacks(x.GETTING_HOME,this._home),this._home}set_home(e){this._home=e,this._call_callbacks(x.SET_HOME,e)}get_root(){return this._call_callbacks(x.GETTING_ROOT,this._root),this._root}set_root(e){this._root=e,this._call_callbacks(x.SET_ROOT,e)}async exists(e){return!!this.#o.has(e)||(this._call_callbacks(x.CHECKING_EXISTS,e),this.exists_direct(e))}absolute(e){if(""===e)return this._root;if("."===e)return this._cwd;if("~"===e)return this._home;if(e.startsWith(this._cwd)&&!e.includes(".."))return e;if(e.startsWith(this._root)&&!e.includes(".."))return e;e.startsWith("./")&&(e=e.slice(2));let t=this._cwd;for(;e.startsWith("..")&&t!==this._root;)(e=e.slice(2)).startsWith("/")&&(e=e.slice(1)),t=t.slice(0,t.lastIndexOf("/"));for(;e.endsWith("..");)(e=e.slice(0,e.lastIndexOf(".."))).endsWith("/")&&(e=e.slice(0,e.length-1)),(""===e||""===(e=e.slice(0,e.lastIndexOf("/"))))&&(t=t.slice(0,t.lastIndexOf("/")));return e.startsWith("~/")&&(e=e.slice(2),t=this._home),e.startsWith("/")&&(e=e.slice(1)),this.join(t,e)}join(e,...t){e.endsWith("/")&&(e=e.slice(0,e.length-1));for(let r of t)r.startsWith("/")&&(r=r.slice(1)),""!==r&&(e+="/"+r);return e}constructor(){setInterval((()=>this.#c()),100)}static create_userspace_proxy(e){const t=e,r=Object.create(null),i=e=>{const r=t.absolute(e);if("/sys"===r||r.startsWith("/sys/")||"/boot"===r||r.startsWith("/boot/"))throw new F(r);return r};return Object.defineProperties(r,{get_unique_fs_type_name:{value:()=>t.get_unique_fs_type_name(),enumerable:!0},erase_all:{value:()=>t.erase_all(),enumerable:!0},purge_cache:{value:e=>t.purge_cache(e),enumerable:!0},read_file:{value:(e,r)=>t.read_file(t.absolute(e),r),enumerable:!0},list_dir:{value:(e,r)=>t.list_dir(t.absolute(e),r),enumerable:!0},exists:{value:e=>t.exists(t.absolute(e)),enumerable:!0},dir_exists:{value:e=>t.dir_exists(t.absolute(e)),enumerable:!0},is_readonly:{value:async e=>{try{i(e)}catch(e){if(e instanceof F)return!0;throw e}return await t.is_readonly(t.absolute(e))},enumerable:!0},join:{value:(e,...r)=>t.join(e,...r),enumerable:!0},absolute:{value:e=>t.absolute(e),enumerable:!0},get_cwd:{value:()=>t.get_cwd(),enumerable:!0},get_home:{value:()=>t.get_home(),enumerable:!0},get_root:{value:()=>t.get_root(),enumerable:!0},write_file:{value:(e,r,n)=>t.write_file(i(e),r,n),enumerable:!0},delete_file:{value:e=>t.delete_file(i(e)),enumerable:!0},move_file:{value:(e,r)=>t.move_file(i(e),i(r)),enumerable:!0},make_dir:{value:e=>t.make_dir(i(e)),enumerable:!0},delete_dir:{value:(e,r)=>t.delete_dir(i(e),r),enumerable:!0},move_dir:{value:(e,r,n)=>t.move_dir(i(e),i(r),n),enumerable:!0},set_readonly:{value:(e,r)=>t.set_readonly(i(e),r),enumerable:!0},set_cwd:{value:e=>t.set_cwd(e),enumerable:!0}}),Object.freeze(r)}}var D,A=r(196);class T{#d=new Map;register_howl(e,t,r=!1){this.#d.set(e,{ready:r,howl:t})}register_file(e,t){const r=new A.Howl({src:[t],onload:()=>{const t=this.#d.get(e);t.ready=!0,this.#d.set(e,t)}});this.register_howl(e,r)}async await_ready(e,t=100){return new Promise(((r,i)=>{const n=setInterval((()=>{this.#d.get(e).ready&&(clearInterval(n),r())}),t)}))}play(e){if(!this.#d.has(e))throw new Error(`Sound "${e}" is not registered.`);if(!this.#d.get(e).ready)throw new Error(`Sound "${e}" is not ready yet.`);this.#d.get(e).howl.play()}get(e){if(!this.#d.has(e))throw new Error(`Sound "${e}" is not registered.`);return this.#d.get(e).howl}is_ready(e){return this.#d.get(e).ready}wait_to_play(e,t=100){this.is_ready(e)?this.play(e):(console.log(`Sound ${e} is not ready yet, waiting...`),this.await_ready(e,t).then((()=>{this.play(e)})))}}class I{#_;#u=new Map;#w=new Map;#h=1;constructor(e){this.#_=e,setInterval((()=>{for(const[e,t]of this.#u)this.#_.get_process(t.pid)||this.#u.delete(e);for(const[e,t]of this.#w){const r=this.#_.get_process(t.initiator),i=this.#_.get_process(t.peer);r&&i||this.#w.delete(e)}}),1e4)}dispose_all(){this.#u.clear(),this.#w.clear()}service_register(e,t,r){this.#u.set(e,{pid:t,on_connection:r})}service_unregister(e){this.#u.delete(e)}service_lookup(e){const t=this.#u.get(e);if(t)return this.#_.get_process(t.pid)?t.pid:void this.#u.delete(e)}create_direct_channel(e,t){const r=this.#h++;return this.#w.set(r,{initiator:e,peer:t,initiator_to_peer_queue:[],peer_to_initiator_queue:[],listeners:new Map}),r}create_channel(e,t){const r=this.service_lookup(t);if(!r)return null;const i=this.create_direct_channel(e,r);return this.#u.get(t).on_connection(i,e).catch((e=>{console.error("IPC service on_connection error:",e)})),i}reserve_kernel_channel(){return this.create_direct_channel(0,-1)}assign_kernel_channel(e,t){const r=this.#w.get(e);return!!r&&0===r.initiator&&-1===r.peer&&(r.peer=t,!0)}destroy_channel(e){this.#w.delete(e)}channel_listen(e,t,r){const i=this.#w.get(e);return!(!i||i.initiator!==t&&i.peer!==t||(i.listeners.has(t)||i.listeners.set(t,new Set),i.listeners.get(t).add(r),0))}channel_unlisten(e,t,r){const i=this.#w.get(e);if(!i)return!1;if(i.initiator!==t&&i.peer!==t)return!1;const n=i.listeners.get(t);return!!n&&(n.delete(r),!0)}channel_send(e,t,r){const i=this.#w.get(e);if(!i)return!1;let n;if(i.initiator===t)n={from:t,to:i.peer,data:r},i.initiator_to_peer_queue.push(n);else{if(i.peer!==t)return!1;n={from:t,to:i.initiator,data:r},i.peer_to_initiator_queue.push(n)}const s=n.to,a=i.listeners.get(s);if(a)for(const e of a)e(n).catch((e=>{console.error("IPC channel listener error:",e)}));return!0}create_userspace_proxy(e){const t=this,r=Object.create(null);return Object.defineProperties(r,{service_register:{value:(r,i)=>{t.service_register(r,e,i)},enumerable:!0},service_unregister:{value:e=>{t.service_unregister(e)},enumerable:!0},service_lookup:{value:e=>t.service_lookup(e),enumerable:!0},create_channel:{value:r=>t.create_channel(e,r),enumerable:!0},destroy_channel:{value:e=>{t.destroy_channel(e)},enumerable:!0},channel_listen:{value:(r,i)=>t.channel_listen(r,e,i),enumerable:!0},channel_unlisten:{value:(r,i)=>t.channel_unlisten(r,e,i),enumerable:!0},channel_send:{value:(r,i)=>t.channel_send(r,e,i),enumerable:!0}}),Object.freeze(r)}}!function(e){e[e.FOREGROUND=0]="FOREGROUND",e[e.BACKGROUND=1]="BACKGROUND",e[e.DETACHED=2]="DETACHED"}(D||(D={}));class O{#g;#m;#p;#f=new Date;#y;#$=new Set;#b=D.FOREGROUND;#v=!1;#k=new Set;#E=new Map;#F=new Map;#x=new Set;#S=new Set;constructor(e,t,r,i){this.#g=e,this.#p=t,this.#m=r,i&&(this.#y=i),t.run_in_bg&&(this.#b=D.BACKGROUND)}get pid(){return this.#g}get source_command(){return this.#p}get created_at(){return this.#f}get shell(){return this.#y}get is_detached(){return this.#b===D.DETACHED}get is_background(){return this.#b===D.BACKGROUND}get is_foreground(){return this.#b===D.FOREGROUND}get attachment(){return this.#b}get detaches_silently(){return this.#v}detach(e=!1){this.#b=D.DETACHED,this.#v=e}dispose_resources(){this.#x.forEach((e=>{clearInterval(e)})),this.#k.forEach((e=>{clearTimeout(e)})),this.#E.clear(),this.#F.clear(),this.#S.forEach((e=>{e.dispose()}))}kill(e=0){this.dispose_resources(),this.#m.mark_terminated(this.#g);for(const t of this.#$)t(e)}add_exit_listener(e){this.#$.add(e)}create_timeout(e,t,r){const i=window.setTimeout((()=>{if(this.#k.delete(i),this.#E.has(i)){const e=this.#E.get(i);for(const{resolve:t}of e)t(!0);this.#E.delete(i)}e(),r&&this.#F.delete(i)}),t);return this.#k.add(i),r&&this.#F.set(i,r),i}cancel_timeout(e){if(this.#k.has(e)){if(clearTimeout(e),this.#k.delete(e),this.#E.has(e)){const t=this.#E.get(e);for(const{resolve:e}of t)e(!1);this.#E.delete(e)}this.#F.has(e)&&(this.#F.get(e)(),this.#F.delete(e))}}has_timeout(e){return this.#k.has(e)}create_interval(e,t){const r=window.setInterval(e,t);return this.#x.add(r),r}has_interval(e){return this.#x.has(e)}clear_interval(e){this.#x.has(e)&&(clearInterval(e),this.#x.delete(e))}async wait_for_timeout(e){if(!this.#k.has(e))throw new Error(`Timeout ID ${e} does not exist.`);return new Promise((t=>{this.#E.has(e)||this.#E.set(e,new Set),this.#E.get(e).add({resolve:t})}))}create_window(){const e=this.#m.window_manager;if(!e)return null;const t=new e.Window(this.#g);return this.#S.add(t),t.add_event_listener("close",(()=>{this.#S.delete(t)})),t}create_userspace_proxy_as_other_process(){const e=this,t=Object.create(null);return Object.defineProperties(t,{pid:{get:()=>e.pid,enumerable:!0},created_at:{get:()=>e.created_at,enumerable:!0},is_detached:{get:()=>e.is_detached,enumerable:!0},is_background:{get:()=>e.is_background,enumerable:!0},is_foreground:{get:()=>e.is_foreground,enumerable:!0},attachment:{get:()=>e.attachment,enumerable:!0},source_command:{get:()=>e.source_command,enumerable:!0}}),Object.freeze(t)}create_userspace_proxy(){const e=this,t=Object.create(null);return Object.defineProperties(t,{pid:{get:()=>e.pid,enumerable:!0},created_at:{get:()=>e.created_at,enumerable:!0},is_detached:{get:()=>e.is_detached,enumerable:!0},is_background:{get:()=>e.is_background,enumerable:!0},is_foreground:{get:()=>e.is_foreground,enumerable:!0},attachment:{get:()=>e.attachment,enumerable:!0},source_command:{get:()=>e.source_command,enumerable:!0},detach:{value:(t=!1)=>{e.detach(t)},enumerable:!0},kill:{value:(t=0)=>{e.kill(t)},enumerable:!0},create_timeout:{value:(t,r)=>e.create_timeout(t,r),enumerable:!0},cancel_timeout:{value:t=>{e.cancel_timeout(t)},enumerable:!0},create_interval:{value:(t,r)=>e.create_interval(t,r),enumerable:!0},clear_interval:{value:t=>{e.clear_interval(t)},enumerable:!0},create_window:{value:()=>e.create_window(),enumerable:!0}}),Object.freeze(t)}}class C{#D=new Map;#A=1;#T;#I=new I(this);constructor(e=null){this.#T=e}get window_manager(){return this.#T}get ipc_manager(){return this.#I}dispose_all(){this.#I.dispose_all();for(const e of this.#D.values())e.dispose_resources();this.#D.clear()}create_process(e,t){const r=this.#A++,i=new O(r,e,this,t);return this.#D.set(r,i),i}get_process(e){return this.#D.get(e)}list_pids(){return Array.from(this.#D.keys())}mark_terminated(e){this.#D.delete(e)}kill(e,t=0){const r=this.#D.get(e);return!!r&&(r.kill(t),!0)}create_userspace_proxy(e){const t=this,r=Object.create(null),i=t.#I.create_userspace_proxy(e);return Object.defineProperties(r,{ipc_manager:{get:()=>i,enumerable:!0},list_pids:{value:()=>t.list_pids(),enumerable:!0},get_process:{value:e=>{const r=t.get_process(e);return r?r.create_userspace_proxy_as_other_process():void 0},enumerable:!0},kill:{value:(e,r)=>t.kill(e,r),enumerable:!0}}),Object.freeze(r)}}var B=r(953),P=r.n(B),R=r(560),L=r.n(R);class j{#O;#_;#C;#B;#P;#T=null;#R=!1;#L=null;#j={version:"unknown",env:"unknown"};#N=null;get privileged(){return!0}get panicked(){return this.#R}get_program_registry(){return this.#C}get_sound_registry(){return this.#B}get_fs(){return this.#P}get_window_manager(){return this.#T}has_window_manager(){return null!==this.#T}get_process_manager(){return this.#_}get_ipc(){return this.#_.ipc_manager}get_env_info(){return{...this.#j}}set_env_info(e,t){this.#j.version=e,this.#j.env=t}spawn=(e,t,r,i)=>{let n;"string"==typeof e?(t||(t=[]),n={command:e,args:[...t],unsubbed_args:[...t],raw_parts:[e,...t],run_in_bg:!1}):n=e;const{command:s}=n,a=n.args.slice(),o=this.#C.getProgram(s);if(void 0===o)throw new Error(`Command not found: ${s}`);if(o.name!==s)throw new Error(`Program name mismatch for command ${s}: expected ${s}, got ${o.name}`);let l="1.0.0";if("string"==typeof o.compat&&(l=o.compat),!P()(l))throw new Error(`Program ${o.name} has an invalid compat SemVer: ${l}`);if(L()(l,"2.0.0")<0)throw new Error(`Program ${o.name} is not compatible with OllieOS 2. (Add compat: "2.0.0" to the program object to mark it as ported.)`);const c=this.#_.create_process(n,r),d=Object.create(null);let _;if(d.kernel=i?this:this.create_userspace_proxy(c),d.term=this.#O,d.args=a,d.shell=r,d.unsubbed_args=n.unsubbed_args,d.raw_parts=n.raw_parts,d.process=c,Object.freeze(d),!("main"in o))throw new Error("Invalid program type");return _=Promise.resolve(o.main(d)),{process:c,completion:_}};panic(e,t){if(this.#R)return;this.#R=!0,console.error(`%cPANIC: ${e}\n${t||""}`,"background: red; color: white; font-weight: bold;");const r=this.get_process_manager(),i=r.list_pids();let n="";for(const e of i){const t=r.get_process(e);t&&(n+=`- PID ${t.pid}: ${t.source_command.command} (started at ${t.created_at.toISOString()})${l}`)}n=n.trimEnd(),r.dispose_all(),this.#O.handle_kernel_panic(e,n,t),this.#L&&this.#L(e,t)}async boot(e,t){this.#L=t||null;const r=this.get_fs(),i=r.absolute("/usr/bin");let n;await r.exists(i)&&await $(r,i,this.get_program_registry(),this.#O);let s=[];try{n=(await r.read_file("/boot/init")).trim()}catch{return this.panic("Failed to read /boot/init to determine init system!"),!1}if(!n)return this.panic("No init program specified in /boot/init!"),!1;const a=n.split(" ");n=a[0],a.length>1&&(s=a.slice(1));try{const t=this.spawn(n,s,void 0,!0);if(this.#N=n,this.#O.focus(),e&&e(this).catch((e=>{console.error(e)})),1!==t.process.pid)return this.panic(`init program ${n} did not start as PID 1!`),!1;try{const e=await t.completion;return this.panic(`init program ${n} exited ${0===e?"unexpectedly":"with an error"}!`,`Exit code: ${e}`),!1}catch(e){return console.error(e),this.panic(`init program ${n} error!`,e.toString()+l+e.stack),!1}}catch(e){return console.error(e),this.panic(`Failed to start init program ${n}!`,e.toString()+l+e.stack),!1}return!0}async request_privilege(e,t){const r=this.get_fs();let i="default_privilege_agent";try{i=(await r.read_file("/sys/privilege_agent")).trim()}catch{console.warn("Failed to read /sys/privilege_agent, using default privilege agent.")}i||(i="default_privilege_agent",console.warn("/sys/privilege_agent is empty, using default privilege agent."));const n=this.get_ipc(),s=n.reserve_kernel_channel(),a=this.spawn(i,[s.toString()]);n.assign_kernel_channel(s,a.process.pid);let o=!1,l=null;n.channel_listen(s,0,(async e=>{const r=e.data;r.process.pid===t.pid?r.handling?o=!0:void 0!==r.granted&&(l=r.granted):console.warn(`Privilege request response pid ${r.process.pid} does not match requesting pid ${t.pid}, ignoring response.`)}));const c=t.create_userspace_proxy_as_other_process(),d=Date.now();for(;Date.now()-d<6e4&&null===l&&(o||Date.now()-d<1e4);)o||n.channel_send(s,0,{process:c,reason:e}),await new Promise((e=>setTimeout(e,500)));return n.destroy_channel(s),null===l&&console.warn("Privilege request timed out."),a.process.kill(null===l?1:0),!!l&&this}constructor(e,t,r,i,n){this.#O=e,this.#P=t,this.#C=r||new b,this.#B=i||new T,this.#T=n||null,this.#_=new C(this.#T)}create_userspace_proxy(e){const t=this,r=Object.create(null),i=t.get_fs(),n=t.get_process_manager().create_userspace_proxy(e.pid),s=t.get_program_registry().create_userspace_proxy(this.#N,i),a=S.create_userspace_proxy(i);return Object.defineProperties(r,{privileged:{value:!1,enumerable:!0},get_program_registry:{value:()=>s,enumerable:!0},get_sound_registry:{value:()=>t.get_sound_registry(),enumerable:!0},get_fs:{value:()=>a,enumerable:!0},get_window_manager:{value:()=>{const e=t.get_window_manager();return e?e.create_userspace_proxy():null},enumerable:!0},has_window_manager:{value:()=>t.has_window_manager(),enumerable:!0},get_process_manager:{value:()=>n,enumerable:!0},get_ipc:{value:()=>n.ipc_manager,enumerable:!0},get_env_info:{value:()=>t.get_env_info(),enumerable:!0},spawn:{value:(e,r,i)=>t.spawn(e,r,i,!1),enumerable:!0},request_privilege:{value:r=>t.request_privilege(r,e),enumerable:!0}}),Object.freeze(r)}}const N="/etc/services/",M=new Set([0,143]);class Y{#M;#Y=new Map;#G=new Map;#U=new Set;#W=new Set;constructor(e){this.#M=e}async load_service_files(){const e=this.#M.get_fs();if(!await e.exists(N))return void console.warn(`Services directory ${N} does not exist. Skipping service loading.`);const t=await e.list_dir(N);for(const r of t)if(r.endsWith(".service.json")){const t=e.join(N,r),i=await e.read_file(t);try{const e=JSON.parse(i),t=r.substring(0,r.length-13),n={id:t,...e};this.#Y.set(t,n)}catch(e){console.error(`Failed to parse service file ${r}:`,e)}}for(const e of this.#Y.keys())t.includes(e+".service.json")||this.#Y.delete(e)}_calculate_service_start_order(){const e=new Set,t=new Set,r=[],i=n=>{if(e.has(n))return;if(t.has(n))throw new Error(`Circular dependency detected involving service: ${n}`);t.add(n);const s=this.#Y.get(n);if(s&&s.dependencies)for(const e of s.dependencies)i(e);t.delete(n),e.add(n),r.push(n)};for(const e of this.#Y.keys())i(e);return r}start_initial_services(){const e=this._calculate_service_start_order();for(const t of e)this.start_service(t)}start_service(e){if(this.#G.has(e))return void console.warn(`Service ${e} is already running.`);const t=this.#Y.get(e);if(!t)return void console.error(`Service ${e} not found.`);let r;this.#U.add(e);try{r=this.#M.spawn(t.exec,t.args||[])}catch(t){return void console.error(`Failed to start service ${e}:`,t)}this.#G.set(e,r),this.#W.delete(e);const{process:i,completion:n}=r;i.detach(!0),n.catch((t=>{console.error(`Service ${e} encountered an error:`,t),this.#G.delete(e),this.#W.add(e),this._handle_service_exit(e,-1)})),i.add_exit_listener((t=>{this.#G.delete(e),this._handle_service_exit(e,t)}))}stop_service(e){if(!this.#G.has(e))return void console.warn(`Service ${e} is not running.`);const t=this.#G.get(e);if(!t)return void console.error(`Service ${e} spawn result not found.`);const{process:r}=t;this.#U.delete(e),r.kill(143)}restart_service(e){this.stop_service(e),this.start_service(e)}get_service_status(e){if(!this.#Y.has(e))return null;if(!this.#G.has(e))return this.#W.has(e)?{state:"failed"}:{state:"stopped"};{const t=this.#G.get(e);if(t)return{state:"running",pid:t.process.pid}}}_handle_service_exit(e,t){if(console.warn(`Service ${e} exited with code ${t}.`),!this.#U.has(e))return;const r=this.#Y.get(e);if(!r)return;const i=r.restart;if(i&&"never"!==i.on&&("always"===i.on||"failure"===i.on&&!M.has(t))){console.log(`Restarting service ${e} as per restart policy.`);let t=0;"delay_ms"in i&&i.delay_ms&&(t=i.delay_ms),setTimeout((()=>{this.start_service(e)}),t)}}}const G={name:"ignition",description:"System init process",usage_suffix:"",arg_descriptions:{},hide_from_help:!0,compat:"2.0.0",main:async e=>{const{kernel:t,term:r,process:i}=e,{CURSOR:n}=g;if(1!==i.pid)return r.writeln("ignition can only be run as PID 1!"),1;if(!t.privileged)return r.writeln("ignition requires privileged environment!"),1;const s=t.get_fs();let a="jetty",o=[];try{a=(await s.read_file("/etc/boot_target")).trim()}catch(e){r.writeln("Warning: /etc/boot_target not found, defaulting to 'jetty' target!"),await new Promise((e=>setTimeout(e,3e3)))}a||(r.writeln("Warning: /etc/boot_target is empty, defaulting to 'jetty' target!"),await new Promise((e=>setTimeout(e,3e3))));const l=a.split(" ");a=l[0],l.length>1&&(o=l.slice(1));const c=new Y(t);await c.load_service_files();const d=t.get_ipc();d.service_register("init",i.pid,(async e=>{d.channel_listen(e,i.pid,(async t=>{const r=t.data;switch(r.type){case"reload_services":await c.load_service_files(),d.channel_send(e,i.pid,{type:"response",message:"Service files reloaded."});break;case"service":{const t=r;switch(t.action){case"start":c.start_service(t.service_id),d.channel_send(e,i.pid,{type:"response",message:`Service ${t.service_id} started.`});break;case"stop":c.stop_service(t.service_id),d.channel_send(e,i.pid,{type:"response",message:`Service ${t.service_id} stopped.`});break;case"restart":c.restart_service(t.service_id),d.channel_send(e,i.pid,{type:"response",message:`Service ${t.service_id} restarted.`});break;case"status":{const r=c.get_service_status(t.service_id);if(!r){d.channel_send(e,i.pid,{type:"error",message:`Service ${t.service_id} not found.`});break}d.channel_send(e,i.pid,{type:"data",data:r});break}default:d.channel_send(e,i.pid,{type:"error",message:`Unknown service action: ${t.action}`})}}break;default:d.channel_send(e,i.pid,{type:"error",message:`Unknown message type: ${r.type}`})}}))}));let _,u=!0,w=0;const h=t.get_process_manager();i.add_exit_listener((async e=>{_&&h.get_process(_.pid)&&_.kill(e),w=e,u=!1})),c.start_initial_services();let m=null,p=0;for(;u;){const e=t.spawn(a,o);let i;_=e.process;let s=null;try{i=await e.completion}catch(e){console.error(e),s=e,i=-1}e.process.kill(i),console.log(`boot target ${a} exited with code ${i}`),r.writeln(`Boot target ${a} exited with code ${i}!`),s&&r.writeln(`Error details: ${s}`);const l=Date.now();if((!m||l-m>1e4)&&(m=l,p=0),p++,p>=5){if(r.writeln("Boot target has crashed too many times in a short period."),r.writeln("Press R key to enter recovery mode, or any other key to retry..."),r.write(n.invisible),"r"===(await r.wait_for_keypress()).key.toLowerCase()){r.writeln("Entering recovery mode...");const e=t.spawn("recovery",[],void 0,!0);let i;try{i=await e.completion,e.process.kill(i)}catch(e){console.error(e),i=-1}r.writeln(`Recovery environment exited with code ${i}. Retrying boot target...`)}else r.writeln("Retrying boot target...");r.write(n.visible),p=0,m=null}}return w}},U={name:"jetty",description:"TTY init process",usage_suffix:"",arg_descriptions:{},hide_from_help:!0,compat:"2.0.0",main:async e=>{const{kernel:t,term:r,process:i}=e;r.reset();const n=t.get_fs();let s="ash",a=[];try{s=(await n.read_file("/etc/default_shell")).trim()}catch(e){r.writeln("Warning: /etc/default_shell not found, defaulting to 'ash' shell!"),await new Promise((e=>setTimeout(e,3e3)))}s||(r.writeln("Warning: /etc/default_shell is empty, defaulting to 'ash' shell!"),await new Promise((e=>setTimeout(e,3e3))));const o=s.split(" ");s=o[0],o.length>1&&(a=o.slice(1));let l,c=!0,d=0;const _=t.get_process_manager();for(i.add_exit_listener((async e=>{l&&_.get_process(l.pid)&&l.kill(e),d=e,c=!1}));c;){const e=t.spawn(s,a);let i;l=e.process;let n=null;try{i=await e.completion,e.process.kill(i)}catch(e){console.error(e),n=e,i=-1}if(console.log(`default shell ${s} exited with code ${i}`),!c)break;r.reset(),r.writeln(0===i?"Logged out.":`Shell exited with code ${i}!`),n&&r.writeln(`Error details: ${n}`),r.writeln(`Press any key to log back in.${g.CURSOR.invisible}`),await r.wait_for_keypress(),r.write(g.CURSOR.visible),r.reset()}return d}};class W{#H=[];current_history_index=0;#J=new Map;#q=new Map;clear_history(){this.#H=[],this.current_history_index=0}get_previous_history_entry(){if(0===this.#H.length||this.current_history_index>=this.#H.length)return;const e=this.#H[this.#H.length-1-this.current_history_index];return this.current_history_index+=1,e}get_next_history_entry(){if(!(0===this.#H.length||this.current_history_index<=0))return this.current_history_index-=1,0===this.current_history_index?"":this.#H[this.#H.length-1-this.current_history_index]}add_history_entry(e){this.#H.push(e),this.current_history_index=0}list_variables(){return this.#J}get_variable(e){return this.#J.get(e)}set_variable(e,t){this.#J.set(e,t)}unset_variable(e){return this.#J.delete(e)}list_aliases(){return this.#q}get_alias(e){return this.#q.get(e)}set_alias(e,t){this.#q.set(e,t)}unset_alias(e){return this.#q.delete(e)}}const H=/^([a-zA-Z0-9_]+)=(.+)$/,J=(e,t)=>{if(0===e.length)return null;const r=e.split(/ +(?=(?:(?:[^"']*["'][^"']*["'])*[^"']*$))/),i=e.trim().split(/ +(?=(?:(?:[^"']*["'][^"']*["'])*[^"']*$))/);for(let e=0;e<i.length;e++){const r=i[e],n=t?t.get_alias(r):void 0;if(!n)break;const s=n.split(/ +(?=(?:(?:[^"']*["'][^"']*["'])*[^"']*$))/);if(n.endsWith(" ")&&s.pop(),i.splice(e,1,...s),e+=s.length-1,!n.endsWith(" "))break}const n=[];for(let e=0;e<i.length;e++){if(0===e)continue;const t=i[e];t.startsWith('"')&&t.endsWith('"')&&(i[e]=t.slice(1,-1)),t.startsWith("'")&&t.endsWith("'")&&(i[e]=t.slice(1,-1),n.push(e-1))}const s=i[0];if("#"===s)return null;if(s.includes("=")){const t=e.match(H);if(t){const e=t[1];let r=t[2];return(r.startsWith("'")||r.startsWith('"'))&&(r=r.slice(1,-1)),{type:"var",var_name:e,var_value:r}}}const a=i.slice(1);let o=!1;a.length>0&&"&"===a[a.length-1]&&(o=!0,a.pop());const l=a.slice();for(let e=0;e<a.length;e++){if(n.includes(e))continue;let r=a[e];r=r.replace(/\$(\w+|\?)|\$\{([^}]+)\}/g,((e,r,i)=>{const n=r||i;return(t?t.get_variable(n):void 0)||e})),a[e]=r}return{type:"command",command:s,args:a,unsubbed_args:l,raw_parts:r,run_in_bg:o}},{PREFABS:q,FG:z,STYLE:V}=g;class X{#M;#O;#z=new W;#V="$ ";_discard_cached_matches=!1;constructor(e,t){this.#O=e,this.#M=t}get memory(){return this.#z}execute=async(e,t=!0,r)=>{const i=this.#M,n=this.#O,s=this.#z;if(0===e.length)return!0;const a=J(e,s);if(null===a)return!0;if("var"===a.type)return s.set_variable(a.var_name,a.var_value),!0;const{command:o}=a;if(!i.get_program_registry().getProgram(o))return n.writeln(`${q.error}Command not found: ${z.white+V.italic}${o}${V.reset_all}`),!1;let l,c="";t&&(c=document.title,document.title=o);try{l=i.spawn(a,void 0,this)}catch(e){return t&&(document.title=c),n.writeln(`${q.error}Failed to execute command: ${z.white+V.italic}${o}${V.reset_all}.`),n.writeln(`${z.red+V.italic}${e.message}${V.reset_all}`),console.error(e),!1}const{process:d,completion:_}=l,u=e=>{if(void 0===e&&(e=-2,console.warn(`Program ${o} did not return an exit code. Defaulting to -2.`)),s.current_history_index=0,t&&(document.title=c),d.is_detached)d.add_exit_listener((e=>{if(r)try{r(e)}catch(e){console.error("Error in program final completion callback for detached process:",e)}if(d.detaches_silently)return;const t=0===e?"Done":`Exit ${e}`,i=0===e?z.green:z.red;n.writeln(""),n.writeln(`${z.gray}[${d.pid}] + ${i}${t}${z.gray} \t ${o}${V.reset_all}`),this.insert_prompt(!1)}));else{if(d.kill(e),r)try{r(e)}catch(e){console.error("Error in program final completion callback:",e)}d.is_background&&n.writeln(`\n${z.gray}[${d.pid}] + Done \t ${o}${V.reset_all}`)}};try{if(d.is_detached)d.detaches_silently||n.writeln(`${z.gray}[${d.pid}] process detached${V.reset_all}`),_.then((e=>{u(e)})).catch((e=>{n.writeln(`${q.error}An unhandled error occurred in detached process [${d.pid}]: ${z.white+V.italic}${o}${V.reset_all}`),console.error(e),u(-1)}));else if(d.is_foreground){const e=await _;u(e),s.set_variable("?",e.toString())}else this.#O.writeln(`${z.gray}[${d.pid}] ${V.italic}running in background${V.reset_all}`),_.then((e=>{u(e)})).catch((e=>{this.#O.writeln(`${q.error}An unhandled error occurred in background process [${d.pid}]: ${z.white+V.italic}${o}${V.reset_all}`),console.error(e),u(-1)}))}catch(e){return n.writeln(`${q.error}An unhandled error occurred while running the command: ${z.white+V.italic}${o}${V.reset_all}`),console.error(e),u(-1),!1}return!0};async run_script(e){const t=this.#M.get_fs();if(await t.exists(e)){const r=await t.read_file(e);for(const e of r.split(l))await this.execute(e)}}get_prompt_suffix(){return this.#V}set_prompt_suffix(e){this.#V=e}get_prompt_string(){const e=this.#M.get_fs();let t=e.get_cwd();return t.startsWith(e.get_home())&&(t=t.replace(new RegExp(`^${e.get_home()}`),"~")),`${q.dir_name}${t}${V.reset_all}${this.#V}`}async insert_prompt(e=!0){const t=this.#O;e&&t.write(l),await new Promise((e=>{t.write(this.get_prompt_string(),(()=>{e()}))}))}}let K=[],Q=0;const Z=async(e,t,r,i,n=!1)=>{if(0!==e.current_line.length){if(e.current_line.includes(" ")){const{match:s,discard_cached_matches:a}=await(async(e,t,r,i,n)=>{const s=await(async(e,t,r,i)=>{const n=J(e.current_line);if("command"!==n.type)return console.warn("Tab completion for non-command lines is not yet implemented"),null;const{command:s,args:a,unsubbed_args:o,raw_parts:l}=n,c=r.get_program_registry().getProgram(s);if(!c)return console.warn(`Tab completion for unknown command "${s}"`),null;if(!c.completion)return console.warn(`Tab completion for command "${s}" with no completion generator is not yet implemented`),null;const d={term:t,kernel:r,shell:i,command:s,args:a,raw_parts:l,unsubbed_args:o,current_partial:l[l.length-1]||"",arg_index:l.length-2},_=await c.completion(d);if((u=_)&&"function"==typeof u[Symbol.asyncIterator]){const e=[];for await(const t of _)e.push(t);return e}return null===_?(console.warn(`Tab completion for command "${s}" with null completion result is not yet implemented`),null):_;var u})(e,i,r,n);if(!s)return{match:"",discard_cached_matches:t};let a;return!t&&K.length>0?(Q=(Q+1)%K.length,a=K[Q]||""):(K=s.filter((t=>t.startsWith(e.current_line.split(" ").pop()||""))),Q=0,a=K[Q]||"",t=!1),{match:a,discard_cached_matches:t}})(e,n,r,t,i);n=a,s&&((e,t,r)=>{const i=t.current_line.split(" "),n=i.pop()||"";e.write("\b \b".repeat(n.length)),e.write(r),i.push(r),t.set_current_line(i.join(" ")),t.set_current_index(t.current_line.length)})(t,e,s)}else{const{match:i,discard_cached_matches:s}=((e,t,r)=>{const i=r.get_program_registry().listProgramNames(!0,!0);let n;return!t&&K.length>0?(Q=(Q+1)%K.length,n=K[Q]||""):(K=i.filter((t=>t.startsWith(e.current_line))),Q=0,n=K[Q]||"",t=!1),{match:n,discard_cached_matches:t}})(e,n,r);n=s,i&&((e,t,r)=>{e.write("\b \b".repeat(t.current_index)),e.write(r),t.set_current_line(r),t.set_current_index(r.length)})(t,e,i)}return n}},ee=e=>async function*(t){const{current_partial:r}=t;for(const t of e)t.startsWith(r)&&(yield t)},te={name:"ash",description:"A shell.",usage_suffix:"[--login] [--no-scripts]",arg_descriptions:{"Arguments:":{"--login":"Start the shell as a login shell. Don't pass this flag manually, it's handled by the system.","--no-scripts":"Do not run any startup scripts like .ashrc or .ash_profile."}},compat:"2.0.0",main:async e=>{const{kernel:t,term:r,process:i,args:n}=e,s=new X(r,t),a=t.get_env_info();s.memory.set_variable("VERSION",a.version),s.memory.set_variable("ENV",a.env);const o=t.get_fs(),c=o.absolute("~/.ash_profile"),d=o.absolute("~/.ashrc"),_=`# ash configuration file${l}# This file is run at login.${l}${l}cat /etc/motd.txt${l}echo "OllieOS v$VERSION ($ENV)"${l}`;await o.exists(c)||await o.write_file(c,_);const u=`# ash configuration file${l}# This file is run when a shell is created.${l}${l}`;await o.exists(d)||await o.write_file(d,u),n.includes("--login")&&("true"===localStorage.getItem("reader")&&await s.execute("reader -s on"),!n.includes("--no-scripts")&&await o.exists(c)&&await s.run_script(c)),!n.includes("--no-scripts")&&await o.exists(d)&&await s.run_script(d);let w=!0,h=0;i.add_exit_listener((e=>{h=e,w=!1}));const g=((e,t)=>({"[A":(t,r,i)=>{const n=e.memory.get_previous_history_entry();n&&(e._discard_cached_matches=!0,r.write(" ".repeat(i.current_line.length-i.current_index)),r.write("\b \b".repeat(i.current_line.length)),r.write(n),i.set_current_line(n),i.set_current_index(n.length))},"[B":(t,r,i)=>{const n=e.memory.get_next_history_entry();e._discard_cached_matches=!0,r.write(" ".repeat(i.current_line.length-i.current_index)),r.write("\b \b".repeat(i.current_line.length)),n?(r.write(n),i.set_current_line(n),i.set_current_index(n.length)):(i.set_current_line(""),i.set_current_index(0))},"\t":async(r,i,n)=>{e._discard_cached_matches=await Z(n,i,t,e,e._discard_cached_matches)},"":()=>{e._discard_cached_matches=!0}}))(s,t),m=(e=>()=>{e._discard_cached_matches=!0})(s);for(;w;){await s.insert_prompt(!0);const e=await r.read_line(g,m);if(e.trim()){if("exit"===e){w=!1;break}s.memory.add_history_entry(e),await s.execute(e)}}return h}},re={name:"default_privilege_agent",description:"Default agent for handling kernel privilege requests",usage_suffix:"",arg_descriptions:{},hide_from_help:!0,compat:"2.0.0",main:async e=>{const{kernel:t,term:r,args:i,process:n}=e,s=i[0];if(!s)return r.writeln("Error in privilege agent: No channel ID provided."),1;const a=parseInt(s,10);if(isNaN(a))return r.writeln("Error in privilege agent: Invalid channel ID."),1;await new Promise((e=>setTimeout(e,250)));const o=t.get_ipc();let c=!1,d=!1;o.channel_listen(a,(async e=>{if(d)return;d=!0;const{process:t,reason:i}=e.data;o.channel_send(a,{process:t,handling:!0}),r.writeln(`${l}${g.STYLE.bold}${g.BG.blue}${g.FG.white}KERNEL PRIVILEGE REQUEST${g.STYLE.reset_all}${g.BG.gray}${l}`),r.writeln(`Process PID ${t.pid} (${t.source_command.command}) is requesting elevated kernel privileges.`),r.writeln(`The process gave the following reason for the request:${l}`),r.writeln(`${g.STYLE.bold}${g.FG.yellow}"${i}"${g.FG.reset}${g.STYLE.no_bold_or_dim}${l}`),r.writeln("Granting this request will allow the process full access to the kernel, which may compromise system security and stability."),r.writeln("It may also be able to temporarily share this access with other running processes."),r.writeln(`${l}Do you wish to grant elevated privileges to PID ${t.pid}? (y/n)${g.STYLE.reset_all}${g.CURSOR.invisible}`);const n=await r.wait_for_keypress();r.write(g.CURSOR.visible),"y"===n.key.toLowerCase()?(r.writeln(`${l}${g.BG.green}${g.FG.white}Privilege request granted.${g.STYLE.reset_all}${l}`),o.channel_send(a,{process:t,granted:!0})):(r.writeln(`${l}${g.BG.red}${g.FG.white}Privilege request denied.${g.STYLE.reset_all}${l}`),o.channel_send(a,{process:t,granted:!1})),c=!0})),n.add_exit_listener((()=>{c=!0}));const _=Date.now();for(;Date.now()-_<6e4&&!c&&(d||Date.now()-_<1e4);){const e=n.create_timeout((()=>{}),100);await n.wait_for_timeout(e)}return 0}},ie={name:"recovery",description:"Emergency recovery environment",usage_suffix:"",arg_descriptions:{},hide_from_help:!0,compat:"2.0.0",main:async e=>{const{kernel:t,term:r}=e,{CURSOR:i}=g;if(!t.privileged)return r.writeln("Recovery requires privileged environment."),1;let n=!0;for(;n;)switch(r.reset(),r.writeln("RECOVERY ENVIRONMENT"),r.writeln("==================="),r.write(l),r.writeln("1. Reboot"),r.writeln("2. Privileged ash shell"),r.writeln("3. Reset bootloader and reboot"),r.writeln("4. Wipe filesystem and reboot"),r.write(l),r.writeln("X: Exit recovery"),r.write(l),r.writeln("Press the corresponding key to select an option."),"undefined"!=typeof window&&r.writeln(`Recovery also available at ${window.location.origin}/recover_fs`),r.write(i.invisible),(await r.wait_for_keypress()).key.toLowerCase()){case"1":r.writeln("\r\nRebooting..."),window.location.reload();break;case"2":{let e;r.writeln("\r\nStarting privileged ash shell..."),r.write(i.visible);const n=t.spawn("ash",["--no-scripts"],void 0,!0);try{e=await n.completion}catch(t){e=-1,r.writeln("Error in privileged shell:"),r.writeln(t)}n.process.kill(e)}break;case"3":{if(r.writeln("Are you sure you want to reset the bootloader? This will clear your choice of init system, boot target, default shell, and privilege agent but retains your files."),r.writeln("Press Y to confirm, or any other key to cancel."),"y"!==(await r.wait_for_keypress()).key.toLowerCase()){r.writeln("Bootloader reset cancelled.");break}r.writeln("\r\nResetting bootloader...");const e=t.get_fs();try{await e.delete_file("/boot/init")}catch(e){r.writeln("Warning: Failed to delete /boot/init"),r.writeln(e)}try{await e.delete_file("/etc/boot_target")}catch(e){r.writeln("Warning: Failed to delete /etc/boot_target"),r.writeln(e)}try{await e.delete_file("/etc/default_shell")}catch(e){r.writeln("Warning: Failed to delete /etc/default_shell"),r.writeln(e)}try{await e.delete_file("/sys/privilege_agent")}catch(e){r.writeln("Warning: Failed to delete /sys/privilege_agent"),r.writeln(e)}r.writeln("Rebooting..."),window.location.reload()}break;case"4":{if(r.writeln("Are you sure you want to erase the filesystem? This action cannot be undone."),r.writeln("Press Y to confirm, or any other key to cancel."),"y"!==(await r.wait_for_keypress()).key.toLowerCase()){r.writeln("Filesystem wipe cancelled.");break}r.writeln("\r\nWiping filesystem...");const e=t.get_fs();try{await e.erase_all()}catch(e){r.writeln("Error: Failed to wipe filesystem."),r.writeln(e)}r.writeln("Rebooting..."),window.location.reload()}break;case"x":r.writeln("\r\nExiting recovery."),n=!1}return 0}},ne=(e,t)=>{t||e.writeln(`${g.STYLE.italic}(Only built-in programs are included. Use the -m flag to include only mounted programs, or the -a flag to include all.)${g.STYLE.reset_all}`),e.writeln(`For help on a specific command, type ${g.PREFABS.program_name}help${g.STYLE.reset_all} [command].`),e.writeln(`The exit code of the most recently executed program is stored in the ${g.PREFABS.variable_name}$?${g.STYLE.reset_all} variable.`),e.writeln(`You can set variables with the syntax ${g.PREFABS.variable_name}variable${g.STYLE.reset_all}=value and unset them with ${g.PREFABS.program_name}unset${g.STYLE.reset_all}.`),e.writeln(`To persist the variables, define them in the ${g.PREFABS.file_path}.ollierc${g.STYLE.reset_all} file in your ${g.PREFABS.dir_name}home${g.STYLE.reset_all} directory.`),e.writeln(`You can run commands in the background by appending ${g.STYLE.bold}${g.FG.magenta}&${g.STYLE.reset_all} to the end of the command.`),e.write(l)},se={name:"help",description:"List programs or get help for a specific program.",usage_suffix:"[command | -s] [-a | -m]",arg_descriptions:{"Arguments:":{command:"The name of the program to get help for."},"Flags:":{"-s":"Single-column mode. Forces the program list to be displayed in a single column.","-a":"All programs. Includes all programs, built-in and mounted.","-m":"Mounted programs. Includes only mounted programs."}},compat:"2.0.0",completion:async e=>e.kernel.get_program_registry().listProgramNames().filter((t=>t.startsWith(e.current_partial))),main:async e=>{const{shell:t,kernel:r,args:i,term:n}=e,{STYLE:s,PREFABS:a}=g,o=r.get_program_registry();let c=!1,_=!1,u=!0;for(let e=0;e<i.length;e++)switch(i[e]){case"-s":c=!0,i.splice(e,1),e--;break;case"-a":_=!0,u=!0,i.splice(e,1),e--;break;case"-m":_=!0,u=!1,i.splice(e,1),e--}if(0===i.length){const e=o.listProgramNames(u,_).filter((e=>{const t=o.getProgram(e);return void 0!==t&&!t.hide_from_help})),i=e.map((e=>`${a.program_name}${e}${s.reset_all} ${o.getProgram(e).usage_suffix}`));if(i.sort(),c)ne(n,_),n.writeln(i.join(l));else{const e=Math.floor(n.cols/2)-1,s=i.filter(((e,t)=>t<=i.length/2)),a=i.filter(((e,t)=>t>i.length/2)),o=Math.max(...i.map((e=>e.replace(d,"").length)));if(e-o<0){n.writeln("Terminal too small to display programs in 2 columns. Re-executing in single-column mode."),n.write(l);const e=["-s"];return _&&e.push("-m"),u&&e.push("-a"),await r.spawn("help",e,t).completion}const c=s.map(((t,r)=>{let i=a[r]??"";const n=t.replace(d,"").length,s=i.replace(d,"").length;return n>e&&(t=t.slice(0,e/2-3)+"..."),s>e&&(i=i.slice(0,e/2-3)+"..."),t+" ".repeat(e-n)+i}));ne(n,_),n.writeln(c.join(l))}return 0}const w=o.getProgram(i[0]);if(void 0===w)return n.writeln(`${a.error}Could not resolve help for ${i[0]}.${s.reset_all}`),1;if(n.writeln(`${l}${a.program_name}${w.name}${s.reset_all}`),n.writeln(`${w.description}`),n.write(l),n.writeln(`Usage: ${a.program_name}${w.name}${s.reset_all} ${w.usage_suffix}`),Object.keys(w.arg_descriptions).length>0){const e=(t,r)=>{let i="";for(const[n,a]of Object.entries(t))"string"==typeof a?i+=`${" ".repeat(4*r)}${n} - ${a}${l}`:(i+=`${l}${" ".repeat(4*r)}${s.bold+s.italic}${n}${s.reset_all}${l}`,i+=e(a,r+1));return i};n.write(l),n.write(e(w.arg_descriptions,0))}return 0}},ae={name:"shutdown",description:"Stops the OS.",usage_suffix:"[-h] [-r] [-t ms]",arg_descriptions:{"Flags:":{"-h":"Show this help message.","-r":"Reboot the terminal.","-t":"Set the time before shutdown in milliseconds. Default is 1000."}},compat:"2.0.0",main:async e=>{const{kernel:t,shell:r,args:i,term:n}=e,{FG:s,STYLE:a}=g;let o=1e3,l=!1;for(const e of i)switch(e){case"-h":return await t.spawn("help",["shutdown"],r).completion;case"-r":l=!0;break;case"-t":{const t=i[i.indexOf(e)+1];if(void 0===t)return n.writeln(`${s.red}Invalid argument: ${e}${a.reset_all}`),1;const r=parseInt(t);if(isNaN(r))return n.writeln(`${s.red}Invalid argument: ${e}${a.reset_all}`),1;o=r,i.splice(i.indexOf(e)+1,1);break}default:return n.writeln(`${s.red}Invalid argument: ${e}${a.reset_all}`),1}l?n.writeln(`${s.red}Restarting...${a.reset_all}`):n.writeln(`${s.red}Shutting down...${a.reset_all}`),setTimeout((()=>{l?window.location.reload():n.dispose()}),o),await new Promise((()=>{}))}},oe={name:"clear",description:"Clears the screen, and/or the scrollback.",usage_suffix:"[-h | -s | -so]",arg_descriptions:{"Flags:":{"-h":"Show this help message.","-s":"Clear the screen and the scrollback.","-so":"Only clear the scrollback."}},compat:"2.0.0",completion:ee(["-h","-s","-so"]),main:async e=>{const{kernel:t,shell:r,args:i,term:n}=e,{FG:s,STYLE:a,PREFABS:o}=g;switch(i[0]){case void 0:n.reset();break;case"-s":if(n.reset(),!r)return n.writeln(`${o.error}Cannot clear scrollback: no shell available.${a.reset_all}`),1;r.memory.clear_history();break;case"-so":if(!r)return n.writeln(`${o.error}Cannot clear scrollback: no shell available.${a.reset_all}`),1;r.memory.clear_history(),n.writeln(`${a.bold+s.gray}Scrollback cleared.${a.reset_all}`);break;case"-h":return await t.spawn("help",["clear"],r).completion;default:return n.writeln(`${s.red}Invalid argument: ${i[0]}${a.reset_all}`),1}return 0}},le={name:"echo",description:"Echos a string to the terminal.",usage_suffix:"string",arg_descriptions:{"Arguments:":{string:"The string to echo."}},compat:"2.0.0",completion:async()=>[],main:async e=>{const{args:t,term:r}=e,i=t.join(" ");return r.writeln(i),0}},ce={name:"unset",description:"Unsets a list of variables.",usage_suffix:"[names...]",arg_descriptions:{"Arguments:":{names:"The names of each variable to unset."}},compat:"2.0.0",completion:async e=>e.shell?[...e.shell.memory.list_variables().keys()].filter((t=>t.startsWith(e.current_partial))):[],main:async e=>{const{shell:t,args:r,term:i}=e;if(!t)return i.writeln("No shell available"),1;for(const e of r)t.memory.unset_variable(e);return 0}},de={name:"ls",description:"List files in the current or another directory.",usage_suffix:"[-h] [-a] [path]",arg_descriptions:{"Arguments:":{path:"The path to the directory to list. Defaults to the current directory."},"Flags:":{"-h":"Show this help message.","-a":"Show hidden files."}},compat:"2.0.0",main:async e=>{const{kernel:t,shell:r,args:i,term:n}=e,{STYLE:s,PREFABS:a}=g,o=t.get_fs();let l=!1,c=o.get_cwd();for(const e of i)switch(e){case"-a":l=!0;break;case"-h":return await t.spawn("help",["ls"],r).completion;default:c=o.absolute(e)}if(!await o.dir_exists(c))return n.writeln(`${a.error}No such directory: ${c}${s.reset_all}`),1;let u=await o.list_dir(c);u.sort(),l||(u=u.filter((e=>!e.startsWith("."))));const w=n.cols;let h="";for(const e of u)h.replace(d,"").replace(_,"").length+e.length+1>w&&(n.writeln(h),h=""),await o.dir_exists(o.join(c,e))?h+=`${a.dir_name}${e}${s.reset_all} `:h+=`${a.file_path}${e}${s.reset_all} `;return n.writeln(h),0}},_e={name:"cd",description:"Change directory.",usage_suffix:"[path]",arg_descriptions:{path:"Path to directory to change to. If no path is given, change to home directory."},compat:"2.0.0",main:async e=>{const{kernel:t,args:r,term:i}=e,{STYLE:n,PREFABS:s}=g,a=t.get_fs();if(0===r.length)return a.set_cwd(a.get_home()),0;if(r.length>1)return i.writeln(`${s.error}Too many arguments${n.reset_all}`),1;const o=r[0],l=a.absolute(o);return await a.dir_exists(l)?(a.set_cwd(l),0):(i.writeln(`${s.error}No such directory: ${o}${n.reset_all}`),1)}},ue={name:"pwd",description:"Print working directory.",usage_suffix:"",arg_descriptions:{},compat:"2.0.0",completion:async()=>[],main:async e=>{const{kernel:t,term:r}=e,{STYLE:i,PREFABS:n}=g,s=t.get_fs();return r.writeln(n.dir_name+s.get_cwd()+i.reset_all),0}},we=(e,t,r,i)=>{const{STYLE:n,BG:s,FG:a}=g;e.clear();const o=r.split("/").pop()||"",c=i?`Viewing read-only file: ${o}`:`Editing file: ${o}`,d=" ".repeat(Math.ceil((e.cols-c.length)/2)),_=" ".repeat(Math.floor((e.cols-c.length)/2));e.write(s.white+a.black+n.bold),e.write(d),e.write(c),e.write(_),e.write(n.reset_all),e.write(`[${e.rows-1};0H`);const u=(i?"":"F1: Save & Exit | ")+"ESC: Exit without saving | F2: Debug Redraw",w=" ".repeat(Math.ceil((e.cols-u.length)/2)),h=" ".repeat(Math.floor((e.cols-u.length)/2));e.write(s.white+a.black+n.bold),e.write(w),e.write(u),e.write(h),e.write(n.reset_all),e.write("[2;0H"),e.write(l),e.write(t),e.write("[2;0H"),e.write(l)},he={name:"edit",description:"Edits the specified file.",usage_suffix:"path",arg_descriptions:{},compat:"2.0.0",main:async e=>{const{kernel:t,args:r,term:i}=e,{STYLE:n,PREFABS:s,FG:a}=g,o=t.get_fs();if(1!==r.length)return i.writeln(`${s.error}A single argument, the path, is required.${n.reset_all}`),1;const d=o.absolute(r[0]);let _="",u=!1;await o.exists(d)&&(_=await o.read_file(d),u=await o.is_readonly(d)),i.writeln(`${a.yellow}Note: This program is still in development and has numerous issues, including no scrolling!${l}Pressing F2 to redraw may help some visual issues, but not any file writing related issues.${l}Consider using ${s.program_name}cat${n.reset_all+a.yellow} or the ${s.program_name}fsedit${n.reset_all+a.yellow} UI for your purposes.${l}Please don't report issues in this program unless you know a fix :)${l}Press any key to proceed.${n.reset_all}`),await i.wait_for_keypress(),we(i,_,d,u);const w=_.split(l);let h=null,m=!1;for(;null===h;){const e=await i.wait_for_keypress();switch(e.domEvent.code){case"Escape":await o.exists(d)&&await o.set_readonly(d,u),h=0;break;case"F1":if(u)break;await o.write_file(d,w.join(l)),m=!0,await o.set_readonly(d,u),h=0;break;case"F2":i.reset(),we(i,w.join(l),d,u),console.log(w.join("\n"));break;case"ArrowUp":{const t=i.buffer.normal.cursorY;if(2===t)break;i.write(e.key);const r=w[t-2-1].length,n=i.buffer.normal.cursorX;n>=r?i.write("\b".repeat(n-r)):i.write("[C".repeat(r-n))}break;case"ArrowDown":{const t=i.buffer.normal.cursorY;if(t===i.rows-4)break;if(t===w.length+2-1)break;i.write(e.key);const r=w[t-2+1].length,n=i.buffer.normal.cursorX;n>=r?i.write("\b".repeat(n-r)):i.write("[C".repeat(r-n))}break;case"ArrowLeft":i.write(e.key);break;case"ArrowRight":i.buffer.normal.cursorX<w[i.buffer.normal.cursorY-2].length&&i.write(e.key);break;case"Enter":{if(u)break;const e=i.buffer.normal.cursorX;let t=i.buffer.normal.cursorY;const r=w[t-2],n=r.slice(0,e),s=r.slice(e);w.slice(),w.splice(t-2,1,n,s),i.reset(),we(i,w.join(l),d,u),i.write(`[${t+2};1H`);break}case"Backspace":{if(u)break;const e=i.buffer.normal.cursorX,t=i.buffer.normal.cursorY;if(0===e&&2===t)break;if(0===e){const e=w[t-2];w[t-2-1]+=e,w.splice(t-2,1),i.reset(),we(i,w.join(l),d,u),i.write(`[${t};${w[t-2-1].length-e.length+1}G`);break}const r=w[t-2].slice(0,e-1),n=w[t-2].slice(e);if(w[t-2]=r+n,i.write("\b"),i.write(n+" "),i.write(`[${n.length+1}D`),2!==t&&""===w[t-2]){w.splice(t-2,1),i.write("[1M");break}e>w[t-2].length&&i.write(`[${w[t-2].length+1}G`)}break;default:{if(u)break;const t=i.buffer.normal.cursorX,r=i.buffer.normal.cursorY;if(!c.test(e.key))if(t===w[r-2].length+1)w[r-2]+=e.key,i.write(e.key);else{const n=w[r-2].slice(0,t),s=w[r-2].slice(t);w[r-2]=n+e.key+s,i.write(e.key+s),i.write(`[${t+2}G`)}}}}return i.reset(),m?i.writeln(`${a.green}File saved!${n.reset_all}`):i.writeln(`${a.red}Exited without saving!${n.reset_all}`),h}},ge={name:"webget",description:"Downloads a file from the World Wide Web.",usage_suffix:"url filepath [-o] [-n] [-X method] [-H header] [-B body]",arg_descriptions:{"Arguments:":{url:"The URL to download from.",filepath:"The path to save the file to."},"Flags:":{"System flags:":{"-h":"Print this help message.","-o":"Overwrite existing files.","-n":"Do not replace newlines with the current system's newline character, store as a binary (binary mode)."},"Request flags:":{"-X":"Specify a custom HTTP method. (default: GET)","-H":"Add a custom header to the request.","-B":"Specify a custom request body. (only works with POST and PUT methods)"}}},compat:"2.0.0",main:async e=>{const{kernel:t,shell:r,args:i,term:n}=e,{PREFABS:s,STYLE:a,FG:o}=g,c=t.get_fs();if("-h"===i[0])return await t.spawn("help",["webget"],r).completion;if(0===i.length)return n.writeln(`${s.error}A URL is required.${a.reset_all}`),1;const d=i.shift();try{const e=new URL(d);if("http:"!==e.protocol&&"https:"!==e.protocol)throw new Error("Invalid protocol")}catch(e){return n.writeln(`${s.error}Invalid URL. Expected a valid HTTP or HTTPS protocol URL.${a.reset_all}`),1}let _="",u=!1,w=!1,h="GET";const m=new Map;let p=null;for(let e=0;e<i.length;e++){const t=i[e];switch(t){case"-X":{const t=i[e+1];if(void 0===t)return n.writeln(`${s.error}Expected a method after -X.${a.reset_all}`),1;h=t,i.splice(e+1,1)}break;case"-H":{const t=i[e+1];if(void 0===t)return n.writeln(`${s.error}Expected a header after -H.${a.reset_all}`),1;const r=t.split(": ");if(2!==r.length||r[0].includes(" "))return n.writeln(`${s.error}Invalid header. Expected a header in the format "Header-Name: Header-Value".${a.reset_all}`),1;m.set(r[0],r[1]),i.splice(e+1,1)}break;case"-B":{const t=i[e+1];if(void 0===t)return n.writeln(`${s.error}Expected a body after -B.${a.reset_all}`),1;p=t,i.splice(e+1,1)}break;case"-o":u=!0;break;case"-n":w=!0;break;default:if(""!==_)return n.writeln(`${s.error}Unexpected string argument.${a.reset_all}`),1;_=t}}if(""===_)return n.writeln(`${s.error}A file path is required.${a.reset_all}`),1;if(_.endsWith("/"))return n.writeln(`${s.error}Cannot write to a directory.${a.reset_all}`),1;const f=c.absolute(_);if(await c.exists(f)&&!u)return n.writeln(`${s.error}File already exists.${a.reset_all}`),1;if(u&&await c.is_readonly(f))return n.writeln(`${s.error}File is readonly.${a.reset_all}`),1;let y;await c.exists(f)||await c.write_file(f,""),await c.set_readonly(f,!0),n.writeln(`${o.green}Downloading file...${a.reset_all}`);try{const e={};m.forEach(((t,r)=>{e[r]=t})),y=await fetch(d,{method:h,headers:e,body:p})}catch(e){return n.writeln(`${s.error}Failed to fetch file.${a.reset_all}`),n.writeln(`${s.error}${"message"in e?e.message:e}${a.reset_all}`),console.error(e),await c.set_readonly(f,!1),u||await c.delete_file(f),1}if(!y.ok){n.writeln(`${s.error}Request not OK.${a.reset_all}`);const e=await y.text();return""!==e&&n.writeln(`${s.error}${e}${a.reset_all}`),await c.set_readonly(f,!1),u||await c.delete_file(f),1}if(w){const e=await y.arrayBuffer();await c.write_file(f,new Uint8Array(e),!0)}else{const e=await y.text();await c.write_file(f,e.replace(/\r?\n/g,l),!0)}return await c.set_readonly(f,!1),n.writeln(`${o.green}File downloaded successfully.${a.reset_all}`),0}},me={name:"cat",description:"Reads files and prints their contents to the terminal.",usage_suffix:"[filepaths...]",arg_descriptions:{"Arguments:":{filepaths:"The paths of the files to read."}},compat:"2.0.0",main:async e=>{const{kernel:t,args:r,term:i}=e,{PREFABS:n,STYLE:s}=g,a=t.get_fs();for(const e of r){const t=a.absolute(e);if(await a.dir_exists(t))return i.writeln(`${n.error}Cannot read a directory: ${t}${s.reset_all}`),1;if(!await a.exists(t))return i.writeln(`${n.error}File not found: ${t}${s.reset_all}`),1;const r=await a.read_file(t);i.writeln(r)}return 0}},pe={name:"hex",description:"Reads a file as hexadecimal.",usage_suffix:"[-h] path [-i]",arg_descriptions:{"Arguments:":{path:"The path to the file to read."},"Flags:":{"-h":"Print this help message.","-i":"Print indexes."}},compat:"2.0.0",completion:async e=>0===e.arg_index?null:1===e.arg_index&&"-i".startsWith(e.current_partial)?["-i"]:[],main:async e=>{const{shell:t,kernel:r,args:i,term:n}=e,{PREFABS:s,STYLE:a,FG:o}=g,l=r.get_fs();if(0===i.length)return n.writeln(`${s.error}A file path is required.${a.reset_all}`),1;"-h"===i[0]&&await r.spawn("help",["hex"],t).completion;const c=i[0],d=l.absolute(c);if(d.endsWith("/"))return n.writeln(`${s.error}Cannot read a directory: ${d}${a.reset_all}`),1;if(!await l.exists(d))return n.writeln(`${s.error}File not found: ${d}${a.reset_all}`),1;const _=await l.read_file(d,!0),u=Array.from(_).map((e=>e.toString(16).toUpperCase().padStart(2,"0")));"-i"===i[1]&&n.writeln(`         ${o.blue}00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F${a.reset_all}`);for(let e=0;e<u.length;e+=16){const t=u.slice(e,e+16);if("-i"===i[1]){const t=e<=4294967295?e.toString(16).toUpperCase():"........";n.write(`${o.blue}${t.padStart(8,"0")}${a.reset_all} `)}const r=t.concat(Array(16-t.length).fill(`${o.gray}..${a.reset_all}`));n.writeln(r.join(" "))}return 0}};var fe=r(336),ye=r.n(fe);const $e="obfuscatedgenerated",be=/^[a-z\d](?:[a-z\d]|-(?=[a-z\d])){0,38}$/i,ve={name:"mefetch",description:"Shows information about me (or you!)",usage_suffix:"[username]",arg_descriptions:{username:"The GitHub username to show basic info about. Defaults to my username, with the special info shown."},compat:"2.0.0",completion:async()=>[],main:async e=>{const{kernel:t,term:r,args:i}=e,{STYLE:n,FG:s}=g,a=t.get_env_info().version,o=Math.floor(.75*r.cols),c=Math.floor(o/3),d=i[0]||$e;if(!d.match(be))return r.write(`${n.bold}${s.red}Invalid username.${n.reset_all}\n`),1;const u=await(async e=>{const t=`https://api.github.com/users/${e}`,r=await fetch(t);if(!r.ok)return null;const i=await r.json();return{name:i.name,bio:i.bio,location:i.location,blog:i.blog,followers:i.followers,following:i.following,twitter:i.twitter_username}})(d);if(null===u)return r.write(`${n.bold}${s.red}User not found.${n.reset_all}\n`),1;const w=$e===d?"https://ollieg.codes/public/logo.png":(e=>`https://avatars.githubusercontent.com/${e}`)(d),h=await(async(e,t)=>{const r=new(ye())(e,t,Math.round(t/2));return await r.loadImage,r.stringANSI8BitColor.replace(/\n/g,l)})(w,c);let m=null;const p=t.get_fs();if(await p.exists("/var/lib/data/person/index.json")){const e=await p.read_file("/var/lib/data/person/index.json");if(JSON.parse(e).includes(d)){const e=await p.read_file(`/var/lib/data/person/${d}.json`);m=JSON.parse(e)}}let f;f=m?((e,t,r,i)=>{const{STYLE:n,FG:s,PREFABS:a}=g;return`\n${n.bold}${e}\n-------------------\n${n.bold}OS${n.reset_all+s.cyan}: OllieOS v${i}\n\n${n.bold}Name${n.reset_all+s.cyan}: ${t.name||r?.name||"Unknown"}\n${n.bold}Pronouns${n.reset_all+s.cyan}: ${t.pronouns.subject}/${t.pronouns.object_or_alt}${t.pronouns.possessive?`/${t.pronouns.possessive}`:""}\n${n.bold}Location${n.reset_all+s.cyan}: ${t.location||r?.location||"Unknown"}\n${n.bold}Interests${n.reset_all+s.cyan}: ${t.interests.join(", ")||"None listed"}\n\n${t.websites?Object.entries(t.websites).map((([e,t])=>`${n.bold}${e}${n.reset_all+s.cyan}: ${t}`)).join(l):""}\n\n${n.bold}GitHub Followers${n.reset_all+s.cyan}: ${r.followers||0}\n${n.bold}GitHub Following${n.reset_all+s.cyan}: ${r.following||0}\n\n${t.extra?Object.entries(t.extra).map((([e,t])=>`${n.bold}${e}${n.reset_all+s.cyan}: ${t}`)).join(l):""}\n        `.replace(/\n/g,l)})(d,m,u,a):((e,t,r,i)=>{const{STYLE:n,FG:s}=g;return t.bio&&(t.bio=t.bio.replace(/\r\n/g,"\n").replace(new RegExp(`(.{${Math.floor(.25*r)}})\\s`,"g"),"$1\n")),`\n${n.bold}${e}\n${"-".repeat(e.length)}\n${n.bold}OS${n.reset_all+s.cyan}: OllieOS v${i}\n\n${t.name?`${n.bold}Name${n.reset_all+s.cyan}: ${t.name}`:"[1A"}\n${t.location?`${n.bold}Location${n.reset_all+s.cyan}: ${t.location}`:"[1A"}\n${t.bio?`${n.bold}Bio${n.reset_all+s.cyan}: ${t.bio}`:"[1A"}\n\n${t.blog?`${n.bold}Website${n.reset_all+s.cyan}: ${t.blog}`:"[1A"}\n\n${n.bold}GitHub${n.reset_all+s.cyan}: https://github.com/${e}\n${t.twitter?`${n.bold}Twitter${n.reset_all+s.cyan}: https://twitter.com/${t.twitter}`:"[1A"}\n\n${n.bold}GitHub Followers${n.reset_all+s.cyan}: ${t.followers||0}\n${n.bold}GitHub Following${n.reset_all+s.cyan}: ${t.following||0}\n    `.replace(/\n/g,l)})(d,u,r.cols,a);const y=s.cyan,$=n.reset_all,b=h.split(l),v=f.split(l),k=Math.max(b.length,v.length),E=Math.max(...b.map((e=>e.replace(_,"").length))),F=Math.max(...v.map((e=>e.length))),x=Math.floor(o/15),S=Math.floor((o-F-E/2-x)/2),D=" ".repeat(x>0?x:0),A=" ".repeat(S>0?S:0);for(let e=0;e<k;e++){const t=b[e]||"",i=v[e]||"",n=" ".repeat(E-t.replace(_,"").length);r.writeln(A+t+n+D+y+i+$)}return 0}},ke={name:"reader",description:"Toggles screen reader mode. Due to a technical limitation, on-screen links will not be clickable in screen reader mode.",usage_suffix:"[-h] [-q] [-s on|off]",arg_descriptions:{"Flags:":{"-h":"Show this help message.","-q":"Query the current screen reader mode.","-s":"Explicitly set the screen reader mode to on or off, rather than toggling it."}},node_opt_out:!0,compat:"2.0.0",completion:async e=>0===e.arg_index?ee(["-h","-q","-s"])(e):1===e.arg_index&&"-s"===e.args[0]?ee(["on","off"])(e):[],main:async e=>{const{kernel:t,shell:r,args:i,term:n}=e,{PREFABS:s,STYLE:a}=g,o=t.get_sound_registry();switch(i[0]){case"-h":return await t.spawn("help",["clear"],r).completion;case"-q":return n.writeln(`Screen reader mode is currently ${n.options.screenReaderMode?"on":"off"}.`),0;case"-s":switch(i[1]){case"on":n.options.screenReaderMode=!0;break;case"off":n.options.screenReaderMode=!1;break;default:return n.writeln('Invalid argument. Expected "on" or "off".'),1}break;default:n.options.screenReaderMode=!n.options.screenReaderMode}const l=n.options.screenReaderMode?"on":"off",c=`reader_${l}`;if(o.wait_to_play(c),n.writeln(`Screen reader mode was turned ${l}. This setting is saved in your browser's local storage. Use the ${s.program_name}reader${a.reset_all} command to toggle it.`),n.options.screenReaderMode){const e=document.querySelector("#screenreader_hint");e&&e.remove()}return localStorage.setItem("reader",n.options.screenReaderMode.toString()),0}},Ee={name:"selfdestruct",description:"Permanently erases the filesystem and other data, then restarts the terminal.",usage_suffix:"",arg_descriptions:{},compat:"2.0.0",completion:async()=>[],main:async e=>{const{kernel:t,shell:r,term:i}=e,{FG:n,BG:s,STYLE:a}=g,o=t.get_fs(),c=(e,t="")=>e.length>=i.cols?e:e+" ".repeat(i.cols-e.length+t.length);i.writeln(s.red+n.white+a.bold),i.write(c("WARNING: This will permanently erase the filesystem and other data, and restart the terminal.")),i.writeln(c("This data cannot be recovered. Are you sure you want to do this?")),i.writeln(c(`Press ${s.blue}Y${s.red} 3 times to continue, or anything else to cancel.`,s.blue+s.red)),i.write(a.reset_all);let d=0;for(;d<3;){const e=await i.wait_for_keypress();if("y"!==e.key&&"Y"!==e.key)return i.writeln("Cancelled."),0;d++}return i.reset(),i.writeln("Erasing filesystem and other data..."),await o.erase_all(),localStorage.removeItem("fetch_ttl_cache"),i.writeln(`${l}Thank you for using OllieOS!${l}`),await t.spawn("shutdown",["-r","-t","3000"],r).completion}};var Fe=r(602);const xe={name:"imagine",description:"Views images natively in the terminal.",usage_suffix:"path [-w width] [-u]",arg_descriptions:{"Arguments:":{path:"The path to the image to view."},"Options:":{"-w":"The width of the image in PIXELS. Defaults to the width of the image.","-u":"Path is an web URL instead of a local filesystem path."}},compat:"2.0.0",main:async e=>{const{kernel:t,args:r,term:i}=e,{STYLE:n,PREFABS:s}=g,a=t.get_fs(),o=r[0];if(!o)return i.writeln(`${s.error}No path specified.${n.reset_all}`),1;let l,c,d=r.includes("-w")?parseInt(r[r.indexOf("-w")+1]):void 0;if(r.includes("-u")){try{new URL(o),l=o}catch(e){return i.writeln(`${s.error}Invalid URL: ${o}${n.reset_all}`),1}try{const e=await fetch(l,{method:"HEAD"});if(e.ok)c=e.headers.get("content-type");else{console.log("HEAD request failed, trying GET request");const e=await fetch(l);if(!e.ok)return i.writeln(`${s.error}URL is not accessible: ${l}${n.reset_all}`),1;c=e.headers.get("content-type")}if(-1===["image/png","image/jpeg","image/gif"].indexOf(c))return i.writeln(`${s.error}URL does not point to a .png, .jpg/.jpeg or .gif: ${l}${n.reset_all}`),1}catch(e){return i.writeln(`${s.error}Error accessing URL: ${l}${n.reset_all}`),1}}else{if(l=a.absolute(o),!await a.exists(l))return i.writeln(`${s.error}No such file or directory: ${o}${n.reset_all}`),1;switch(l.slice(-4).toLowerCase()){case".png":c="image/png";break;case".jpg":case"jpeg":c="image/jpeg";break;case".gif":c="image/gif";break;default:return i.writeln(`${s.error}File is not known to be a .png, .jpg/.jpeg or .gif: ${l}${n.reset_all}`),1}const e=await a.read_file(l,!0);l=URL.createObjectURL(new Blob([e]))}const _=await(async e=>{const t=document.createElement("canvas"),r=t.getContext("2d"),i=new Image;i.crossOrigin="anonymous",i.src=e;try{await new Promise(((e,t)=>{i.onload=()=>{e(null)},i.onerror=()=>{t(null)}}))}catch(e){return null}t.width=i.width,t.height=i.height,r.drawImage(i,0,0);const n=r.getImageData(0,0,i.width,i.height);return{array:new Uint8Array(n.data),width:i.width,height:i.height}})(l);if(!_)return i.writeln(`${s.error}Failed to convert image to data. Did you download it as a binary file?${n.reset_all}`),1;const{array:u,width:w,height:h}=_;d||(d=w);const m=d/w,p=h*m,f=new Uint8Array(d*p*4);for(let e=0;e<f.length;e++){const t=Math.floor(e/4)%d,r=Math.floor(Math.floor(e/4)/d),i=Math.floor(t/m),n=4*(Math.floor(r/m)*w+i)+e%4;f[e]=u[n]}try{const e=(0,Fe.image2sixel)(f,d,p);i.write(e)}catch(e){return i.writeln(`${s.error}Failed to convert image to sixel.${n.reset_all}`),console.error(e),1}return 0}},Se={name:"ascmagine",description:"Views images as ANSI/ASCII art.",usage_suffix:"path [-w width] [-u]",arg_descriptions:{"Arguments:":{path:"The path to the image to view."},"Options:":{"-w":"The width of the image in COLUMNS. Defaults to the width of the terminal.","-u":"Path is an web URL instead of a local filesystem path."}},compat:"2.0.0",main:async e=>{const{kernel:t,args:r,term:i}=e,{STYLE:n,PREFABS:s,FG:a}=g,o=t.get_fs(),c=r[0];if(!c)return i.writeln(`${s.error}No path specified.${n.reset_all}`),1;const d=r.includes("-w")?parseInt(r[r.indexOf("-w")+1]):void 0;let _;if(r.includes("-u")){try{new URL(c),_=c}catch(e){return i.writeln(`${s.error}Invalid URL: ${c}${n.reset_all}`),1}const e=await fetch(_,{method:"HEAD"});let t;if(e.ok)t=e.headers.get("content-type");else{console.log("HEAD request failed, trying GET request");const e=await fetch(_);if(!e.ok)return i.writeln(`${s.error}URL is not accessible: ${_}${n.reset_all}`),1;t=e.headers.get("content-type")}if(!t.startsWith("image/"))return i.writeln(`${s.error}URL is not an image: ${_}${n.reset_all}`),1}else{if(_=o.absolute(c),!await o.exists(_))return i.writeln(`${s.error}No such file or directory: ${c}${n.reset_all}`),1;const e=await o.read_file(_,!0),t=new Blob([e]);if("function"==typeof createImageBitmap)try{await createImageBitmap(t,0,0,1,1)}catch(e){return i.writeln(`${s.error}File is not a valid image: ${c}. Did you download it as a binary file?${n.reset_all}`),1}else{i.writeln(`${a.yellow}Warning: ${n.reset_all}createImageBitmap is not supported in this browser. Falling back to list of trusted image formats.${n.reset_all}`);const e=[".png",".jpg",".jpeg",".gif",".bmp",".ico",".svg"],t=_.slice(-4).toLowerCase();if(!e.includes(t))return i.writeln(`${s.error}File is not a valid image: ${c}. Did you download it as a binary file?${n.reset_all}`),1}_=URL.createObjectURL(new Blob([e]))}const u=await(async(e,t)=>{const r=new(ye())(e,t,Math.round(t/2));return await r.loadImage,r.stringANSI8BitColor.replace(/\n/g,l)})(_,d||i.cols-1);return i.write(u),0}},De={name:"fsedit",description:"Opens the fsedit program to edit the filesystem.",usage_suffix:"[directory]",arg_descriptions:{"Arguments:":{directory:"The directory to open fsedit in. Defaults to the current working directory."}},compat:"2.0.0",main:async e=>{const{kernel:t,args:r,term:i,process:n}=e,{PREFABS:s,STYLE:a}=g,o=t.get_fs(),l=o.get_unique_fs_type_name();let c=o.get_cwd();if(r.length>1)return i.writeln(`${s.error}Too many arguments.${a.reset_all}`),1;if(1===r.length&&(c=o.absolute(r[0])),!await o.dir_exists(c))return i.writeln(`${s.error}Directory '${r[0]}' does not exist.${a.reset_all}`),1;const d=encodeURIComponent(c);if(!t.has_window_manager())return window.open(`./fsedit?type=${l}&dir=${d}`,"_blank","popup=true"),i.writeln("Opened fsedit in a new popup window."),0;const _=document.createElement("iframe");_.src=`./fsedit?type=${l}&dir=${d}`,_.style.border="none",_.style.width="100%",_.style.height="100%";const u=n.create_window();u.title="fsedit",u.width="75vw",u.height="75vh",u.x="12.5vw",u.y="12.5vh",u.dom.appendChild(_),u.show(),i.writeln("Opened fsedit in a new window."),u.add_event_listener("close",(async()=>{if(await o.exists("/.fs.lock")){let e=!1;const r=t.get_process_manager().list_pids();for(const i of r){if(i===n.pid)continue;const r=t.get_process_manager().get_process(i);if(r&&"fsedit"===r.source_command.command){e=!0;break}}e||await o.delete_file("/.fs.lock")}n.kill(0)}));const w=e=>{e.source===_.contentWindow&&"closing-fsedit"===e.data&&(u.close(),window.removeEventListener("message",w))};return window.addEventListener("message",w),n.detach(),0}},Ae={name:"rm",description:"Deletes a file or directory.",usage_suffix:"[-rf | -f] path",arg_descriptions:{"Arguments:":{path:"The path to the file or directory to delete."},"Flags:":{"-rf":"Recursively and forcibly delete directories (ignoring if directory has content, treated as -f if a file is passed).","-f":"Forcibly delete files (ignoring readonly state, NOT treated as -rf if a directory is passed)."}},compat:"2.0.0",main:async e=>{const{kernel:t,args:r,term:i}=e,{PREFABS:n,STYLE:s}=g,a=t.get_fs();let o=!1,l=!1;if("-rf"===r[0]?(o=!0,l=!0,r.shift()):"-f"===r[0]&&(l=!0,r.shift()),1!==r.length)return i.writeln(`${n.error}Invalid arguments.${s.reset_all}`),1;const c=r[0],d=a.absolute(c);if(!await a.exists(d))return i.writeln(`${n.error}Path does not exist.${s.reset_all}`),1;if(await a.dir_exists(d))try{await a.delete_dir(d,o)}catch(e){if(e instanceof k)return i.writeln(`${n.error}Directory is not empty. Refusing to delete without -rf flag.${s.reset_all}`),1;if(e instanceof v)return i.writeln(`${n.error}Path no longer exists.${s.reset_all}`),1;throw e}else{if(!l&&await a.is_readonly(d))return i.writeln(`${n.error}File is readonly. Refusing to delete without -f flag.${s.reset_all}`),1;await a.delete_file(d)}return 0}},Te={bug:"?assignees=&labels=awaiting+effort+estimate%2C+awaiting+triage%2C+bug%2C+unreviewed&template=bug-report-%F0%9F%90%9B.md&title=%5B%F0%9F%90%9B%5D+-+Descriptive%2C+short+title",feature:"?assignees=&labels=awaiting+effort+estimate%2C+awaiting+triage%2C+feature%2C+unreviewed&template=feature-request-%F0%9F%92%A1.md&title=%5B%F0%9F%92%A1%5D+-+Descriptive%2C+short+title",other:"/choose"},Ie={name:"bugreport",description:"Opens the bug reporter.",usage_suffix:"[bug|feature|other]",arg_descriptions:{bug:"Opens the bug reporter with the bug report template.",feature:"Opens the bug reporter with the feature request template.",other:"Opens the bug reporter with the template chooser (default)."},compat:"2.0.0",completion:ee(["bug","feature","other"]),main:async e=>{const{term:t,args:r}=e,{STYLE:i,PREFABS:n}=g;let s="other";return r.length>0&&(s=r[0].toLowerCase(),!Object.keys(Te).includes(s))?(t.writeln(`${n.error} Invalid type: ${s}. Please choose bug, feature, or other.${i.reset_all}`),1):(window.open(`https://github.com/obfuscatedgenerated/obfuscatedgenerated.github.io/issues/new${Te[s]}`,"_blank",""),t.writeln("Opened bug reporter in a new tab."),0)}},Oe={name:"repo",description:"Opens the GitHub repository for OllieOS.",usage_suffix:"",arg_descriptions:{},compat:"2.0.0",completion:async()=>[],main:async e=>{const{term:t}=e;return window.open("https://github.com/obfuscatedgenerated/obfuscatedgenerated.github.io","_blank",""),t.writeln("Opened repo in a new tab."),0}};var Ce=r(167);const Be=/<\/?[a-z][\s\S]*>/i,Pe={feed:{},item:{}};var Re;Pe.feed={author:["author","creator"],publisher:["dc:publisher","publisher"],title:["dc:title","title"],description:"description",date:"pubDate",link:"link"},Pe.item={author:["author","creator"],date:["dc:date","date","pubDate"],title:["dc:title","title"],link:"link",summary:"summary",description:["content:encoded","content","description"]},function(e){e[e.FEED=0]="FEED",e[e.ITEM=1]="ITEM"}(Re||(Re={}));const Le=(e,t,r,i=!1)=>{const n=t===Re.FEED?Pe.feed:Pe.item;if(!Object.keys(n).includes(r))return;const s=n[r];if(Array.isArray(s)){let t="";for(const r of s){const n=e.getElementsByTagName(r)[0];let s;s=i?n?.innerHTML:n?.textContent,s&&(t+=s)}return t}return i?e.getElementsByTagName(s)[0]?.innerHTML:e.getElementsByTagName(s)[0]?.textContent},je={name:"rss",description:"Reads from an RSS feed.",usage_suffix:"[-h] [url] [-m items] [-x]",arg_descriptions:{"Arguments:":{url:"The URL to the XML feed (plaintext feed recommended, unless the HTML is basic). Defaults to https://blog.ollieg.codes/rss/feed.xml"},"Flags:":{"-h":"Print this help message.","-m":"The maximum number of items to display. Defaults to no limit.","-x":"Only display titles, links and publishing dates, not descriptions."}},compat:"2.0.0",main:async e=>{const{kernel:t,shell:r,args:i,term:n}=e,{PREFABS:s,STYLE:a,FG:o}=g;if(i.includes("-h"))return await t.spawn("help",["rss"],r).completion;let c;if(i.includes("-m")){const e=i.indexOf("-m"),t=i[e+1];if(!t||isNaN(parseInt(t))||parseInt(t)<0)return n.writeln(`${s.error}Invalid value for -m flag. Expected a positive integer.${a.reset_all}`),1;c=parseInt(t),i.splice(e,2)}const d=i.includes("-x");let _,u="https://blog.ollieg.codes/rss/feed.xml";0!==i.length&&(u=i.shift());try{const e=new URL(u);if("http:"!==e.protocol&&"https:"!==e.protocol)throw new Error("Invalid protocol")}catch(e){return n.writeln(`${s.error}Invalid URL. Expected a valid HTTP or HTTPS protocol URL.${a.reset_all}`),1}n.writeln(`${o.green}Fetching feed...${a.reset_all}`);try{_=await fetch(u)}catch(e){return n.writeln(`${s.error}Failed to fetch feed.${a.reset_all}`),n.writeln(`${s.error}${"message"in e?e.message:e}${a.reset_all}`),console.error(e),1}if(!_.ok){n.writeln(`${s.error}Request not OK.${a.reset_all}`);const e=await _.text();return""!==e&&n.writeln(`${s.error}${e}${a.reset_all}`),1}const w=(await _.text()).replace(/\r\n|\n/g,l),h=new DOMParser;let m;try{m=h.parseFromString(w,"text/xml")}catch(e){return n.writeln(`${s.error}Failed to parse feed.${a.reset_all}`),n.writeln(`${s.error}${"message"in e?e.message:e}${a.reset_all}`),console.error(e),1}n.write(l);const p=Le(m,Re.FEED,"title")??"Untitled feed";n.writeln(`${o.cyan+a.bold+a.italic}${p}${a.reset_all}`);const f=Le(m,Re.FEED,"link")??"";n.writeln(`${o.cyan}${f}${a.reset_all}`);const y=Le(m,Re.FEED,"description")??"";n.writeln(`${y}`),n.write(l),n.writeln(`${o.gray}------${a.reset_all}`),n.write(l);const $=m.getElementsByTagName("item");void 0===c&&(c=$.length);for(let e=0;e<c;e++){const t=$.item(e);if(!t)break;const r=Le(t,Re.ITEM,"title")??"Untitled item",i=Le(t,Re.ITEM,"link")??"";let s="";d||(s=Le(t,Re.ITEM,"description")??"",Be.test(s)&&(n.writeln(`${o.gray}(interpreting description as HTML)${a.reset_all}`),n.write(l),s=Le(t,Re.ITEM,"description",!0)??"",s=s.replace(/<!\[CDATA\[|\]\]>/g,""),s=(0,Ce.convert)(s,{formatters:{ansi_formatter:(e,t,r,i)=>{r.openBlock(),r.addInline(i.opener),t(e.children,r),r.addInline(a.reset_all),r.closeBlock()},img_highlight:(e,t,r,i)=>{const n=r.options.formatters.image;n&&(r.addInline(a.bold+o.magenta),n(e,t,r,i),r.addInline(a.reset_all))},a_highlight:(e,t,r,i)=>{const n=r.options.formatters.anchor;n&&(r.addInline(a.bold+o.blue),n(e,t,r,i),r.addInline(a.reset_all))}},selectors:[{selector:"b",format:"ansi_formatter",options:{opener:a.bold}},{selector:"strong",format:"ansi_formatter",options:{opener:a.bold}},{selector:"i",format:"ansi_formatter",options:{opener:a.italic}},{selector:"em",format:"ansi_formatter",options:{opener:a.italic}},{selector:"u",format:"ansi_formatter",options:{opener:a.underline}},{selector:"img",format:"img_highlight"},{selector:"a",format:"a_highlight"},{selector:"table",format:"dataTable"}]})),s=s.trim(),s=s.replace(/\r\n|\n/g,l));const c=Le(t,Re.ITEM,"date")??"";n.writeln(`${o.green+a.bold+a.underline}${r}${a.reset_all}`),n.writeln(`${o.cyan}${i}${a.reset_all}`),n.writeln(`${o.yellow}${c}${a.reset_all}`),n.write(l),d||(n.writeln(`${s}`),n.write(l)),n.writeln(`${o.gray}------${a.reset_all}`),n.write(l)}return 0}},Ne={name:"legacy",description:"Opens the legacy ollieg.codes site if you're having trouble with this version.",usage_suffix:"",arg_descriptions:{},compat:"2.0.0",completion:async()=>[],main:async e=>(window.location.assign("https://legacy.ollieg.codes/"),0)},Me=e=>(e.write(l),e.writeln(`${g.STYLE.italic}Press any key to continue...${g.STYLE.reset_all}`),e.wait_for_keypress()),Ye=async(e,t,r=[])=>{e.term.writeln(`${g.STYLE.bold}$ ${t}${g.STYLE.reset_all}${l}`),await e.kernel.spawn(t,r,e.shell).completion,e.term.write(l)},Ge={name:"tour",description:"Runs the onboarding tour.",usage_suffix:"",arg_descriptions:{},compat:"2.0.0",completion:async()=>[],main:async e=>(await(async e=>{const{STYLE:t,PREFABS:r,FG:i}=g,{term:n}=e;n.reset(),n.writeln(`${t.bold+i.magenta}Welcome to OllieOS!`),n.writeln(`===================${t.reset_all}`),n.write(l),n.writeln("This tour covers the basic commands and features of OllieOS."),n.writeln(`First, let's use ${r.program_name}mefetch${t.reset_all} to view info about me.`),n.write(l),n.writeln("Normally, you would type the command into the terminal and press RETURN, but for this tour, the command will be run automatically."),n.write(l),await Me(n)})(e),await(async e=>{const{STYLE:t,PREFABS:r,FG:i}=g,{term:n}=e;n.reset(),n.writeln(`${t.bold+i.magenta}mefetch`),n.writeln(`=======${t.reset_all}`),n.write(l),await Ye(e,"mefetch"),n.writeln(`The ${r.program_name}mefetch${t.reset_all} command is used to display information about a GitHub user.`),n.writeln("By default, it uses my username, obfuscatedgenerated. You can also specify a different username as an argument."),n.writeln("If another username is used, less information will be displayed."),n.write(l),n.write(`Now, let's use ${r.program_name}rss${t.reset_all} to read my blog.`),n.write(l),await Me(n)})(e),await(async e=>{const{STYLE:t,PREFABS:r,FG:i}=g,{term:n}=e;n.reset(),n.writeln(`${t.bold+i.magenta}rss`),n.writeln(`===${t.reset_all}`),n.write(l),await Ye(e,"rss",["-m","1"]),n.writeln(`The ${r.program_name}rss${t.reset_all} command is used to read RSS feeds.`),n.writeln("By default, it uses my blog's RSS feed. You can also specify a different RSS feed as an argument."),n.writeln("A plaintext RSS feed is recommended, but the program can also parse basic HTML."),n.write(l),n.writeln("For the output above, the -m 1 flag was used to only display the first item in the feed. Without it, all items would be displayed."),n.write(l),n.writeln(`Let's use the ${r.program_name}help${t.reset_all} command to view a list of all available commands, and to get help with a specific command.`),n.write(l),await Me(n)})(e),await(async e=>{const{STYLE:t,PREFABS:r,FG:i}=g,{term:n}=e;n.reset(),n.writeln(`${t.bold+i.magenta}Filesystem`),n.writeln(`==========${t.reset_all}`),n.write(l),n.writeln("OllieOS has a filesystem, which is used to store files and folders."),n.writeln("The filesystem is persistent, so files and folders will not be deleted when the OS is restarted."),n.write(l),n.writeln(`Let's use the ${r.program_name}ls${t.reset_all} command to view the contents of the home directory.`),n.write(l),await Ye(e,"ls"),n.writeln(`There's a file in the directory called ${r.file_path}credits.txt${t.reset_all}. Let's use the ${r.program_name}cat${t.reset_all} command to view its contents.`),n.write(l),await Me(n),await Ye(e,"cat",["credits.txt"]),n.writeln(`The ${r.program_name}cat${t.reset_all} command is used to view the contents of one or more files.`),n.writeln("If multiple files are specified, their contents will be concatenated together."),n.write(l),n.writeln(`There are many other commands that can be used to interact with the filesystem, such as ${r.program_name}cd${t.reset_all}, ${r.program_name}fsedit${t.reset_all}, ${r.program_name}rm${t.reset_all}, and more.`),n.writeln(l),await Me(n)})(e),await(async e=>{const{STYLE:t,PREFABS:r,FG:i}=g,{term:n}=e;n.reset(),n.writeln(`${t.bold+i.magenta}help`),n.writeln(`====${t.reset_all}`),n.write(l),await Ye(e,"help"),n.write(l),n.write(l),n.writeln(`The ${r.program_name}help${t.reset_all} command is used to view a list of all available commands, and to get help with a specific command.`),n.writeln("If a command is specified as an argument, the help text for that command will be displayed."),n.write(l),n.writeln(`For example, let's view the help text for the ${r.program_name}rss${t.reset_all} command:`),n.write(l),await Me(n),await Ye(e,"help",["rss"]),await Me(n)})(e),await(async e=>{const{STYLE:t,FG:r,PREFABS:i}=g,{term:n}=e;n.reset(),n.writeln(`${t.bold+r.magenta}Thanks for using OllieOS!`),n.writeln(`=========================${t.reset_all}`),n.write(l),n.writeln("That's all for now!"),n.writeln("There is a lot more to explore, so feel free to play around with the OS and try out different commands."),n.write(l),n.writeln("Things to try:"),n.writeln(` - Use ${i.program_name}mefetch${t.reset_all}, passing your GitHub username as an argument.`),n.writeln(` - Use ${i.program_name}cd${t.reset_all} to enter the ${i.dir_name}projects${t.reset_all} directory, and then use ${i.program_name}ls${t.reset_all} to view its contents.`),n.writeln(` - Use ${i.program_name}imagine${t.reset_all} and ${i.program_name}ascmagine${t.reset_all} to view an image.`),n.writeln(` - Use ${i.program_name}fsedit${t.reset_all} to explore the filesystem.`),n.writeln(` - Use ${i.program_name}webget${t.reset_all} to download a file from the Internet into the OS.`),n.write(l),n.writeln("Thanks for using OllieOS."),n.writeln("The OS will now restart."),n.write(l),await Me(n),await Ye(e,"shutdown",["-r","-t","0"])})(e),0)},{STYLE:Ue,PREFABS:We,FG:He}=g,Je=async e=>{const{args:t,term:r,kernel:i,shell:n}=e;if(t.shift(),0===t.length)return r.writeln(`${We.error}Missing package name.`),r.writeln(`Try 'pkg -h' for more information.${Ue.reset_all}`),1;let s=[...new Set(t)];for(const e of s)e.includes("@")&&(r.writeln(`${He.yellow}Warning: ${e} contains a version specifier.`),r.writeln(`This will be ignored.${Ue.reset_all}`));s=s.map((e=>e.split("@")[0])),s=[...new Set(s)];let a=0;const o=i.get_fs(),c=i.get_program_registry(),d=s.length;for(;s.length>=1;){r.writeln(`${l}${He.gray}------------------------${Ue.reset_all}${l}`);const e=s.shift();if(r.writeln(`${He.yellow}Checking for ${e}...${Ue.reset_all}`),e.includes("..")||e.includes("/")||e.includes("\\")){r.writeln(`${We.error}Illegal package name '${e}'.${Ue.reset_all}`),a++,r.writeln(`${He.yellow}Skipping package...${Ue.reset_all}`);continue}const t=`/usr/bin/${e}`;if(!await o.dir_exists(t)){r.writeln(`${We.error}Package '${e}' not installed.${Ue.reset_all}`),a++,r.writeln(`${He.yellow}Skipping package...${Ue.reset_all}`);continue}r.writeln(`${He.yellow}Updating graph...${Ue.reset_all}`);let d={},_="unknown",u=[];if(await o.exists(o.join(t,"meta.json")))try{const e=await o.read_file(o.join(t,"meta.json")),r=JSON.parse(e);d=r.triggers||{},_=r.version||"unknown",u=r.deps||[]}catch(t){r.writeln(`${He.yellow+Ue.bold}Warning: Could not read meta.json for package ${e}: ${t.message}${Ue.reset_all}`)}for(const t of u)try{const r=t.split("@")[0];await gt.remove_pkg_dependent(o,r,e)}catch(i){r.writeln(`${He.yellow+Ue.bold}Warning: Could not remove dependent ${e} from package ${t}: ${i.message}${Ue.reset_all}`)}try{await gt.remove_pkg(o,e)}catch(t){r.writeln(`${We.error}Error removing package '${e}': ${t.message}${Ue.reset_all}`),a++,r.writeln(`${He.yellow}Skipping package...${Ue.reset_all}`);continue}r.writeln(`${He.cyan}Unmounting programs...${Ue.reset_all}`);const w=await o.list_dir(t);for(const e of w){if(!e.endsWith(".js"))continue;const i=o.join(t,e);let n;try{const e=await o.read_file(i);n=await f(e)}catch(t){if(t.message.endsWith("is not compatible with Node.js."))continue;r.writeln(`${We.error}Error determining program name for ${e}: ${t.message}${Ue.reset_all}`),r.writeln(`${He.yellow}Skipping program (will remain mounted until restart)...${Ue.reset_all}`);continue}try{await c.unregister(n),r.writeln(`${He.cyan}(-) ${n}${Ue.reset_all}`)}catch(e){r.writeln(`${He.yellow+Ue.bold}Warning: Program ${n} was never registered.${Ue.reset_all}`)}}if(r.writeln(`${He.yellow}Removing package data...${Ue.reset_all}`),await o.delete_dir(t,!0),o.purge_cache(),r.writeln(`${He.green}Package '${e}' removed.${Ue.reset_all}`),d&&Object.keys(d).length>0){r.writeln(`${He.cyan}Processing uninstall triggers...${Ue.reset_all}`);for(const[t,s]of Object.entries(d))await mt.trigger_exists(o,t)?(r.writeln(`${He.cyan}Processing uninstall trigger: ${t}...${Ue.reset_all}`),await mt.process_uninstall_trigger(t,s,e,_,r,i,n)):r.writeln(`${He.yellow}Warning: trigger '${t}' is not recognised and will be skipped.${Ue.reset_all}`);r.writeln(`${He.cyan}Uninstall trigger processing complete.${Ue.reset_all}`)}}return r.writeln(`${l}${He.magenta+Ue.bold}========================${Ue.reset_all}${l}`),a>0?(r.writeln(`${We.error}Failed to remove ${a} package(s).${Ue.reset_all}`),r.writeln(`${He.green}Successfully removed ${d-a} package(s).${Ue.reset_all}`),r.writeln(`${He.cyan}Total packages: ${d}${Ue.reset_all}`),1):(r.writeln(`${He.green}Successfully removed all ${d} package(s).${Ue.reset_all}`),0)},{STYLE:qe,PREFABS:ze,FG:Ve}=g,Xe=async(e,t)=>{const{args:r,term:i,kernel:n,shell:s}=e;if(r.shift(),0===r.length)return i.writeln(`${ze.error}Missing package name.`),i.writeln(`Try 'pkg -h' for more information.${qe.reset_all}`),1;const a=[...new Set(r)];let o=0;const c=n.get_fs(),d=n.get_program_registry(),_=a.length;for(;a.length>=1;){i.writeln(`${l}${Ve.gray}------------------------${qe.reset_all}${l}`);const r=a.shift(),_=r.split("@");if(_.length>2)return i.writeln(`${ze.error}Invalid package name: ${r}`),i.writeln(`Try 'pkg -h' for more information.${qe.reset_all}`),2;const u=_[0];let w=_[1];i.writeln(`${Ve.yellow}Checking for ${u}...${qe.reset_all}`);const h=await _t.get_pkg_json(u);if(!h){i.writeln(`${ze.error}Package '${u}' not found.${qe.reset_all}`),o++,i.writeln(`${Ve.yellow}Skipping package ${u}...${qe.reset_all}`);continue}w||(w=h.latest_version),i.writeln(`${Ve.yellow}Using ${u}@${w}...${qe.reset_all}`);const g=await _t.get_pkg_meta(u,w);if(!g){i.writeln(`${ze.error}Version '${w}' of '${u}' not found.${qe.reset_all}`),o++,i.writeln(`${Ve.yellow}Skipping package ${u}...${qe.reset_all}`);continue}if(!g.externals||"global"!==g.externals){i.writeln(`${ze.error}Package '${u}' is not using the new global externals system. Please build the package with a newer version of pkgbuild.${qe.reset_all}`),o++,i.writeln(`${Ve.yellow}Skipping package ${u}...${qe.reset_all}`);continue}const m=`/usr/bin/${u}`;if(gt.pkg_is_installed(u)){if(gt.get_pkg_version(u)===w){i.writeln(`${Ve.yellow+qe.bold}Warning: ${u}@${w} already installed. If you wish to reinstall the package, remove it first.${qe.reset_all}`);continue}{i.writeln(`${Ve.yellow}Uninstalling old ${u}@${w}...${qe.reset_all}`);const t={kernel:n,term:i,process:e.process,args:["remove",u],unsubbed_args:["remove",u],raw_parts:[...e.raw_parts,"remove",u]};if(0!==await Je(t)){i.writeln(`${ze.error}Failed to uninstall old version.${qe.reset_all}`),o++,i.writeln(`${Ve.yellow}Skipping package ${u}...${qe.reset_all}`);continue}}}if(g.deps&&g.deps.size>0){i.writeln(`${l+Ve.magenta+qe.bold}Installing dependencies...${qe.reset_all}`);const t=[...g.deps];t.unshift("add");const r={kernel:n,term:i,process:e.process,args:t,unsubbed_args:t,raw_parts:[...e.raw_parts,...t]};if(0!==await Xe(r,u)){i.writeln(`${ze.error}Failed to install dependencies.${qe.reset_all}`),o++,i.writeln(`${Ve.yellow}Skipping package ${u}...${qe.reset_all}`);continue}i.writeln(`${Ve.magenta+qe.bold}Dependencies installed.${qe.reset_all+l}`)}i.writeln(`${Ve.yellow}Enumerating contents...${qe.reset_all}`);const p=g.files;if(0===p.length||1===p.length&&""===p[0]){i.writeln(`${ze.error}Empty package.${qe.reset_all}`),o++,i.writeln(`${Ve.yellow}Skipping package ${u}...${qe.reset_all}`);continue}const f=new Map;for(const e of p){if(""===e)continue;i.writeln(`${Ve.yellow}Downloading ${e}...${qe.reset_all}`);const t=await _t.get_pkg_file(u,w,e);t?f.set(e,t):(i.writeln(`${ze.error}Not found.${qe.reset_all}`),o++,i.writeln(`${Ve.yellow}Skipping package ${u}...${qe.reset_all}`))}f.set("pkg.json",JSON.stringify(h)),f.set("meta.json",JSON.stringify(g,ut)),i.writeln(`${Ve.yellow}Updating graph...${qe.reset_all}`);try{await gt.install_new_pkg(c,u,w,g.deps,!t,t)}catch(e){i.writeln(`${ze.error}Failed to add to graph: ${e.message}${qe.reset_all}`),o++,i.writeln(`${Ve.yellow}Skipping package ${u}...${qe.reset_all}`);continue}try{if(g.deps&&g.deps.size>0)for(const e of g.deps){const t=e.split("@")[0];await gt.add_pkg_dependent(c,t,u)}}catch(e){i.writeln(`${ze.error}Failed to update dependencies: ${e.message}${qe.reset_all}`),o++,i.writeln(`${Ve.yellow}Rolling back graph...${qe.reset_all}`),await gt.remove_pkg(c,u),i.writeln(`${Ve.yellow}Skipping package ${u}...${qe.reset_all}`);continue}i.writeln(`${Ve.yellow}Installing ${u}...${qe.reset_all}`),await c.make_dir(m);for(const[e,t]of f)await c.write_file(`${m}/${e}`,t,!0);i.writeln(`${Ve.green}Installed!${qe.reset_all}`),i.writeln(`${Ve.cyan}Mounting package ${u}...${qe.reset_all}`);for(const[e,t]of f)e.endsWith(".js")&&await d.mount_and_register_with_output(e,t,i,!0);if(i.writeln(`${Ve.green}Package ${u}@${w} installed.${qe.reset_all}`),g&&g.triggers&&Object.keys(g.triggers).length>0){i.writeln(`${Ve.cyan}Processing install triggers...${qe.reset_all}`);for(const[e,t]of Object.entries(g.triggers))await mt.trigger_exists(c,e)?(i.writeln(`${Ve.cyan}Processing install trigger: ${e}...${qe.reset_all}`),await mt.process_install_trigger(e,t,u,w,i,n,s)):i.writeln(`${Ve.yellow}Warning: trigger '${e}' is not recognised and will be skipped.${qe.reset_all}`);i.writeln(`${Ve.cyan}Install trigger processing complete.${qe.reset_all}`)}}return i.writeln(`${l}${Ve.magenta+qe.bold}========================${qe.reset_all}${l}`),o>0?(i.writeln(`${ze.error}Failed to install ${o} package(s).${qe.reset_all}`),i.writeln(`${Ve.green}Successfully installed ${_-o} package(s).${qe.reset_all}`),i.writeln(`${Ve.cyan}Total packages: ${_}${qe.reset_all}`),1):(i.writeln(`${Ve.green}Successfully installed all ${_} package(s).${qe.reset_all}`),0)},{STYLE:Ke,FG:Qe}=g,{STYLE:Ze,PREFABS:et}=g,tt=(e,t,r,i,n)=>{e.write(l),e.writeln(`Package: ${Ze.bold}${t}${Ze.no_bold_or_dim}`),e.writeln(`Version: ${Ze.bold}${r}${Ze.no_bold_or_dim}`),e.writeln(`Description: ${i.description||"No description provided."}`),e.writeln(`Author: ${i.author||"Unknown"}`),e.writeln(`License: ${i.license||"Unknown"}`),e.writeln(`Installed: ${Ze.bold}${n?"Yes":"No"}${Ze.no_bold_or_dim}`),i.homepage_url&&e.writeln(`Homepage: ${i.homepage_url}`),i.repo_url&&e.writeln(`Repository: ${i.repo_url}`),i.long_desc&&(e.write(l),e.writeln(`Long description available. Use ${et.program_name}pkg${Ze.reset_all+Ze.italic} read${Ze.reset_all} ${t} to read it.`))},{STYLE:rt,FG:it,CURSOR:nt}=g,st=async(e,t,r,i)=>{const n=await _t.get_pkg_json(e),s=await _t.get_pkg_versions(e);t.clear(),t.write(l),t.writeln(`${rt.bold}${it.cyan}${e}`),t.write(rt.dim),t.writeln("=".repeat(e.length)),t.writeln(rt.reset_all);const a=gt.get_pkg_version(e);t.write(l),t.writeln(`${rt.bold}Available versions:${rt.no_bold_or_dim}`);for(const e of s)t.writeln(`  - ${e} ${a===e?`${rt.italic}(installed)${rt.reset_all}`:""}`);t.write(l),t.writeln(`${rt.bold}Description:${rt.no_bold_or_dim} ${n.description||"No description provided."}`),t.writeln(`${rt.bold}Author:${rt.no_bold_or_dim} ${n.author||"Unknown"}`),t.writeln(`${rt.bold}License:${rt.no_bold_or_dim} ${n.license||"Unknown"}`);let o=!1;n.homepage_url&&(o||(t.write(l),o=!0),t.writeln(`${rt.bold}Homepage:${rt.no_bold_or_dim} ${n.homepage_url}`)),n.repo_url&&(o||(t.write(l),o=!0),t.writeln(`${rt.bold}Repository:${rt.no_bold_or_dim} ${n.repo_url}`)),t.write(l),t.writeln(`${rt.dim}Press 'i' to install the latest version of this package.${rt.reset_all}`),t.writeln(`${rt.dim}Press any other key to return to the list...${rt.reset_all}`),"i"===(await t.wait_for_keypress()).domEvent.key&&(t.write(l),t.write(`${rt.bold}Are you sure you want to install '${e}'? (y/N)${rt.no_bold_or_dim}`),"y"===(await t.wait_for_keypress()).domEvent.key.toLowerCase()?(t.write(" yes"),t.write(l),await r.spawn("pkg",["add",e],i).completion,t.write(l),t.writeln(`${rt.dim}Press any key to return to the list...${rt.reset_all}`),await t.wait_for_keypress()):(t.write(" no"),t.writeln(l),t.writeln(`${rt.dim}Installation cancelled. Press any key to return to the list...${rt.reset_all}`),await t.wait_for_keypress()))},at=new URL("https://ollieg.codes/pkg_repo"),ot="/var/lib/pkg",lt=ot+"/graph.json",ct="/var/lib/pkg/triggers",dt=(e,t)=>{const r=new URL(e.toString());let i=r.pathname;i.endsWith("/")&&(i=i.slice(0,i.length-1));for(const e of t){if(e.includes("/")||e.includes("\\")||e.includes(".."))throw new Error("Unsafe pathname: "+e);i+=""===e?"":"/"+e}return r.pathname=i,r},_t={api_call:async e=>{const t=new URL(e,at),r=await fetch(t.toString());if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return await r.text()},get_pkg_json:async e=>{e=(e=encodeURI(e)).replace(/\./g,"%2E");const t=dt(at,["pkgs",e,"pkg.json"]),r=await fetch(t.toString());if(!r.ok){if(404===r.status)return null;throw new Error(`HTTP error! status: ${r.status}`)}return await r.json()},get_pkg_meta:async(e,t)=>{e=encodeURI(e),t=encodeURI(t),e=e.replace(/\./g,"%2E"),t=t.replace(/\./g,"%2E");const r=dt(at,["pkgs",e,t,"meta.json"]),i=await fetch(r.toString());if(!i.ok){if(404===i.status)return null;throw new Error(`HTTP error! status: ${i.status}`)}const n=await i.json();return n.deps=new Set(n.deps),n},get_pkg_file:async(e,t,r)=>{e=encodeURI(e),t=encodeURI(t),r=encodeURI(r),e=e.replace(/\./g,"%2E"),t=t.replace(/\./g,"%2E"),r=r.replace(/\./g,"%2E");const i=dt(at,["pkgs",e,t,r]),n=await fetch(i.toString());if(!n.ok){if(404===n.status)return null;throw new Error(`HTTP error! status: ${n.status}`)}return await n.text()},get_provided_list:async()=>{const e=dt(at,["provided.txt"]),t=await fetch(e.toString());if(!t.ok){if(404===t.status)return null;throw new Error(`HTTP error! status: ${t.status}`)}return(await t.text()).split("\n").map((e=>e.trim())).filter((e=>e.length>0))},get_pkg_versions:async e=>{e=(e=encodeURI(e)).replace(/\./g,"%2E");const t=dt(at,["pkgs",e,"versions.txt"]),r=await fetch(t.toString());if(!r.ok){if(404===r.status)return null;throw new Error(`HTTP error! status: ${r.status}`)}return(await r.text()).split("\n").map((e=>e.trim())).filter((e=>e.length>0))}},ut=(e,t)=>{if("deps"!==e&&"dependents"!==e)return t;if(t instanceof Set)return Array.from(t);throw new Error(`${e} not a set in graph to be stringified!`)},wt=(e,t)=>{if("deps"!==e&&"dependents"!==e)return t;if(Array.isArray(t))return new Set(t);throw new Error(`${e} not an array in graph to be parsed!`)};let ht={};const gt={get_pkg_info:e=>ht[e],list_pkgs:(e=!1)=>{const t=Object.keys(ht);return e?t.filter((e=>ht[e].top_level)):t},pkg_is_installed:(e,t)=>!(!ht[e]||t&&ht[e].version!==t),get_pkg_version:e=>ht[e]?.version,get_pkg_dependents:e=>ht[e]?.dependents,get_pkg_dependencies:e=>ht[e]?.deps,install_new_pkg:async(e,t,r,i,n,s)=>{if(ht[t])throw new Error(`Package ${t} is already installed and cannot be modified.`);if(!n&&!s)throw new Error(`Package ${t} is not installed as a top-level package but does not have a dependent it was installed by.`);const a=new Set;s&&a.add(s),ht[t]={version:r,deps:i,top_level:n,dependents:a},await e.write_file(lt,JSON.stringify(ht,ut))},promote_pkg_to_top_level:async(e,t)=>{if(!ht[t])throw new Error(`Package ${t} is not installed.`);ht[t].top_level=!0,await e.write_file(lt,JSON.stringify(ht,ut))},demote_pkg_from_top_level:async(e,t)=>{if(!ht[t])throw new Error(`Package ${t} is not installed.`);if(ht[t].dependents.size>0)throw new Error(`Package ${t} has no dependents and cannot be demoted. Use add_pkg_dependent FIRST.`);ht[t].top_level=!1,await e.write_file(lt,JSON.stringify(ht,ut))},add_pkg_dependent:async(e,t,r,i=!1)=>{if(!ht[t])throw new Error(`Package ${t} is not installed.`);if(!ht[r])throw new Error(`Dependent ${r} is not installed.`);const n=`${t}@${ht[t].version}`;ht[t].dependents.add(r),i&&ht[r].deps.add(n),await e.write_file(lt,JSON.stringify(ht,ut))},remove_pkg_dependent:async(e,t,r,i=!1)=>{if(!ht[t])throw new Error(`Package ${t} is not installed.`);if(!ht[r])throw new Error(`Dependent ${r} is not installed.`);if(!ht[t].dependents.has(r))throw new Error(`Package ${t} does not have dependent ${r}.`);const n=`${t}@${ht[t].version}`;if(!ht[r].deps.has(t)&&!ht[r].deps.has(n))throw new Error(`Inconsistent graph! Dependent ${r} does not have dependency ${t}, but ${t} has dependent ${r}.`);ht[t].dependents.delete(r),i&&ht[r].deps.delete(n),await e.write_file(lt,JSON.stringify(ht,ut))},remove_pkg:async(e,t,r=!1)=>{if(!ht[t])throw new Error(`Package ${t} is not installed.`);if(!r&&ht[t].dependents.size>0)throw new Error(`Package ${t} has dependents and cannot be removed.`);for(const e of ht[t].deps){const r=e.split("@")[0];ht[r].dependents.delete(`${t}@${ht[t].version}`)}delete ht[t],await e.write_file(lt,JSON.stringify(ht,ut))},list_unused_pkgs:()=>Object.keys(ht).filter((e=>!ht[e].top_level&&0===ht[e].dependents.size)),get_file_path_in_pkg_bin:(e,t,r)=>{const i=e.join("/usr/bin",t);return e.join(i,r)}},mt={load_trigger_file:async(e,t)=>{const r=e.join(ct,t+".json");if(!await e.exists(r))return null;const i=await e.read_file(r);try{return JSON.parse(i)}catch(e){return null}},trigger_exists:async(e,t)=>null!==await mt.load_trigger_file(e,t),process_install_trigger:async(e,t,r,i,n,s,a)=>{const o=s.get_fs(),l=await mt.load_trigger_file(o,e);if(!l)return!1;if(!l.install_exec)return!0;const c=JSON.stringify(t);let d;console.log(`Processing install trigger ${e} with exec ${l.install_exec} and args [${r}, ${i}, ${c}]`);try{d=s.spawn(l.install_exec,[r,i,c],a);const t=await d.completion;0!==t&&n.writeln(`${g.PREFABS.error}Warning: trigger ${e} exited with code ${t}.${g.STYLE.reset_all}`),d.process.kill(t)}catch(t){n.writeln(`${g.PREFABS.error}Warning: trigger ${e} failed: ${t}.${g.STYLE.reset_all}`),d&&d.process.kill(-1)}return!0},process_uninstall_trigger:async(e,t,r,i,n,s,a)=>{const o=s.get_fs(),l=await mt.load_trigger_file(o,e);if(!l)return!1;if(!l.uninstall_exec)return!0;const c=JSON.stringify(t);let d;console.log(`Processing uninstall trigger ${e} with exec ${l.uninstall_exec} and args [${r}, ${i}, ${c}]`);try{d=s.spawn(l.uninstall_exec,[r,i,c],a);const t=await d.completion;0!==t&&n.writeln(`${g.PREFABS.error}Warning: trigger ${e} exited with code ${t}.${g.STYLE.reset_all}`),d.process.kill(t)}catch(t){n.writeln(`${g.PREFABS.error}Warning: trigger ${e} failed: ${t}.${g.STYLE.reset_all}`),d&&d.process.kill(-1)}return!0}},{STYLE:pt,PREFABS:ft}=g,yt={name:"pkg",description:"The package manager for OllieOS.",usage_suffix:"[-h] [subcommand] [arguments]",arg_descriptions:{"Subcommands:":{add:`Installs a list of packages: ${ft.program_name}pkg${pt.reset_all+pt.italic} add <packages...>${pt.reset_all}`,remove:`Uninstalls a list of packages: ${ft.program_name}pkg${pt.reset_all+pt.italic} remove <packages...>${pt.reset_all}`,list:`Lists all installed packages: ${ft.program_name}pkg${pt.reset_all+pt.italic} list [-t]${pt.reset_all}`,info:`Displays information about a package: ${ft.program_name}pkg${pt.reset_all+pt.italic} info [-r] <package>${pt.reset_all}`,read:`Reads the long description for a package if it has one: ${ft.program_name}pkg${pt.reset_all+pt.italic} read [-r] <package>${pt.reset_all}`,browse:`Browse the repository for packages and versions: ${ft.program_name}pkg${pt.reset_all+pt.italic} browse${pt.reset_all}`,clean:`Removes all packages that are not top level and have no dependents (and are therefore unused): ${ft.program_name}pkg${pt.reset_all+pt.italic} clean [-d]${pt.reset_all}`},"Arguments:":{"-h":"Displays this help message.","For add:":{packages:"The packages to install, separated by spaces. If you wish to install a specific version, use the format 'package@version'."},"For remove:":{packages:"The packages to uninstall, separated by spaces."},"For list:":{"-t":"List only top-level packages."},"For info:":{"-r":"Always fetch the latest information from the repository.",package:"The package to get information about."},"For read:":{"-r":"Always fetch the latest information from the repository.",package:"The package to read the long description of."},"For clean:":{"-d":"Dry run. Lists the packages that would be removed without actually removing them."}}},compat:"2.0.0",completion:async e=>{switch(e.arg_index){case 0:return ee(["add","remove","list","info","read","browse","clean"])(e);case 1:if(["info","read","remove"].includes(e.args[0])){const t=e.kernel.get_fs();let r={};try{r=JSON.parse(await t.read_file("/var/lib/pkg/graph.json"),wt)}catch(e){return[]}const i=Object.keys(r);return ee(i)(e)}}return[]},main:async e=>{const{args:t,term:r,kernel:i,shell:n}=e,s=i.get_fs();if(0===t.length)return r.writeln(`${ft.error}Missing subcommand.`),r.writeln(`Try 'pkg -h' for more information.${pt.reset_all}`),1;if(t.includes("-h"))return await i.spawn("help",["pkg"],n).completion;await s.exists(ot)||await s.make_dir(ot),await s.exists(lt)||await s.write_file(lt,"{}"),await s.exists(ct)||await s.make_dir(ct);const a=s.join(ct,"create_trigger.json");if(!await s.exists(a)){const e={install_exec:"trigger_create_trigger",uninstall_exec:"trigger_remove_trigger"};await s.write_file(a,JSON.stringify(e))}try{ht=JSON.parse(await s.read_file("/var/lib/pkg/graph.json"),wt)}catch(e){return r.writeln(`${ft.error}Fatal error: could not load package graph.${pt.reset_all}`),2}switch(t[0]){case"add":return await Xe(e);case"remove":return await Je(e);case"list":return await(async e=>{const{args:t,term:r}=e;t.shift();let i=!1;"-t"===t[0]&&(i=!0,t.shift()),r.write(l);const n=gt.list_pkgs(i);for(const e of n){const t=gt.get_pkg_info(e);let i=Qe.gray;t.top_level?i=Qe.green:0!==t.dependents.size&&(i=Qe.white),r.writeln(`${Ke.bold}${i}${e}${Ke.no_bold_or_dim}@${t.version}${Ke.reset_all}`)}return 0})(e);case"info":return await(async e=>{const{args:t,term:r,kernel:i}=e;t.shift();let n=!1;if("-r"===t[0]&&(n=!0,t.shift()),0===t.length)return r.writeln(`${et.error}Missing package name.`),r.writeln(`Try 'pkg -h' for more information.${Ze.reset_all}`),1;const s=t[0],a=s.split("@");if(a.length>2)return r.writeln(`${et.error}Invalid package name: ${s}`),r.writeln(`Try 'pkg -h' for more information.${Ze.reset_all}`),2;const o=a[0];let l=a[1];if(!l){const e=gt.get_pkg_version(o);if(e&&!n)l=e;else{const e=await _t.get_pkg_json(o);if(!e)return r.writeln(`${et.error}Package not found: ${o}`),r.writeln(`Try 'pkg -h' for more information.${Ze.reset_all}`),3;l=e.latest_version}}const c=gt.get_pkg_version(o)===l,d=i.get_fs();if(!n&&c){const e=gt.get_file_path_in_pkg_bin(d,o,"pkg.json");if(!d.exists(e))return console.error(`Invalid pkg.json path: ${e}`),r.writeln(`${et.error}Error reading package files for ${o}`),3;const t=await d.read_file(e),i=JSON.parse(t);return tt(r,o,l,i,!0),0}const _=await _t.get_pkg_json(o);return _?(tt(r,o,l,_,c),0):(r.writeln(`${et.error}Package not found: ${o}`),r.writeln(`Try 'pkg -h' for more information.${Ze.reset_all}`),3)})(e);case"read":case"clean":r.writeln(`${ft.error}Not implemented yet.${pt.reset_all}`);break;case"browse":return await(async e=>{const{args:t,term:r,kernel:i,shell:n}=e;t.shift();const s=await _t.get_provided_list();let a=0,o=0;const c=()=>{r.clear(),r.write(l),r.writeln("(use up/down arrow keys to scroll, enter to show more info, escape to quit)"),r.write(l),r.write(nt.invisible),a>0?r.writeln(`  ${rt.dim}...${rt.reset_all}`):r.write(l);const e=s.slice(a,a+10);for(const[t,i]of e.entries()){const e=gt.get_pkg_version(i);a+t===o?r.write(`${it.cyan}${rt.dim}> ${rt.no_bold_or_dim}${rt.bold}`):r.write("  "),r.writeln(`${i} ${e?`${rt.italic}(installed: ${e})`:""}${rt.reset_all}`)}a+10<s.length?r.writeln(`  ${rt.dim}...${rt.reset_all}`):r.write(l)};let d=!1;for(;!d;){c();const e=await r.wait_for_keypress();switch(console.log(e),e.domEvent.key){case"Escape":d=!0;break;case"ArrowUp":o>0&&(o--,o<a&&a--);break;case"ArrowDown":o<s.length-1&&(o++,o>=a+10&&a++);break;case"Enter":{const e=s[o];await st(e,r,i,n);break}}}return r.clear(),r.write(nt.visible),0})(e);default:return r.writeln(`${ft.error}Invalid subcommand.`),r.writeln(`Try 'pkg -h' for more information.${pt.reset_all}`),1}return 0}},$t={name:"touch",description:"Creates a file.",usage_suffix:"file",arg_descriptions:{"Arguments:":{file:"The file to create."}},compat:"2.0.0",main:async e=>{const{kernel:t,args:r,term:i}=e,{STYLE:n,PREFABS:s}=g,a=t.get_fs();if(0===r.length)return i.writeln(`${s.error}Missing file operand.${n.reset_all}`),1;if(r.length>1)return i.writeln(`${s.error}Too many arguments${n.reset_all}`),1;const o=r[0],l=a.absolute(o);if(await a.exists(l))return 0;const c=l.split("/").slice(0,-1).join("/");return await a.dir_exists(c)?(await a.write_file(l,""),0):(i.writeln(`${s.error}No such directory: ${c}${n.reset_all}`),1)}},bt={name:"mkdir",description:"Creates a directory.",usage_suffix:"[-p] directory",arg_descriptions:{"Flags:":{"-p":"Create parent directories (recursive) if they don't exist."},"Arguments:":{directory:"The directory to create."}},compat:"2.0.0",completion:async()=>[],main:async e=>{const{kernel:t,args:r,term:i}=e,{PREFABS:n,STYLE:s}=g,a=t.get_fs();let o=!1;if("-p"===r[0]&&(o=!0,r.shift()),1!==r.length)return i.writeln(`${n.error}Invalid arguments.${s.reset_all}`),1;const l=r[0],c=a.absolute(l);if(await a.dir_exists(c))return 0;if(o)await a.make_dir(c);else{const e=c.split("/").slice(0,-1).join("/");if(!await a.dir_exists(e))return i.writeln(`${n.error}No such directory: ${e}${s.reset_all}`),1;await a.make_dir(c)}return 0}},vt={name:"mv",description:"Moves files and directories.",usage_suffix:"[-n] source destination",arg_descriptions:{"Arguments:":{source:"The file or directory to move.",destination:"The new location for the file or directory.","-n":"Do not overwrite an existing file."}},compat:"2.0.0",main:async e=>{const{kernel:t,args:r,term:i}=e,{PREFABS:n,STYLE:s}=g,a=t.get_fs();let o=!1;"-n"===r[0]&&(o=!0,r.shift());const l=a.absolute(r[0]),c=r[1],d=c.endsWith("/");let _=a.absolute(c);if(!await a.exists(l))return i.writeln(`${n.error}No such file or directory: ${l}${s.reset_all}`),1;const u=await a.dir_exists(_);if((o||u&&!await a.dir_exists(l)&&d)&&await a.exists(_))return i.writeln(`${n.error}File or directory already exists: ${_}${s.reset_all}`),1;if(await a.dir_exists(l))try{await a.move_dir(l,_,d)}catch(e){return i.writeln(`${n.error}Error moving directory: ${e.message}${s.reset_all}`),1}else{if(!await a.exists(l))return i.writeln(`${n.error}Source is neither a file nor a directory: ${l}${s.reset_all}`),1;await a.move_file(l,_)}return 0}},{STYLE:kt,FG:Et}=g,{STYLE:Ft,FG:xt}=g,{STYLE:St,FG:Dt,PREFABS:At}=g,{STYLE:Tt,FG:It,PREFABS:Ot}=g,{STYLE:Ct,FG:Bt,PREFABS:Pt}=g,{STYLE:Rt,FG:Lt,PREFABS:jt}=g,{STYLE:Nt,PREFABS:Mt}=g,Yt={name:"window",description:"Interact with program windows.",usage_suffix:"[-h] [subcommand] [arguments]",arg_descriptions:{"Subcommands:":{info:`Displays information about the window manager and open windows: ${Mt.program_name}window${Nt.reset_all+Nt.italic} info${Nt.reset_all}`,list:`Lists all open windows: ${Mt.program_name}window${Nt.reset_all+Nt.italic} list [-vi]${Nt.reset_all}`,show:`Shows a window by its ID: ${Mt.program_name}window${Nt.reset_all+Nt.italic} show <window_id>${Nt.reset_all}`,hide:`Hides a window by its ID: ${Mt.program_name}window${Nt.reset_all+Nt.italic} hide <window_id>${Nt.reset_all}`,close:`Closes a window by its ID: ${Mt.program_name}window${Nt.reset_all+Nt.italic} close <window_id>${Nt.reset_all}. Note that this does not terminate the process that opened the window.`,center:`Centers a window by its ID: ${Mt.program_name}window${Nt.reset_all+Nt.italic} show <window_id>${Nt.reset_all}`},"Arguments:":{"-h":"Displays this help message.","For list:":{"-v":"List only visible windows.","-i":"List only invisible (minimised/hidden) windows."},"For show, hide, close, and center:":{"<window_id>":"The ID of the window."}}},compat:"2.0.0",completion:async e=>{switch(e.arg_index){case 0:return ee(["info","list","show","hide","close","center"])(e);case 1:if("list"===e.raw_parts[1])return ee(["-v","-i"])(e);if(["show","hide","close","center"].includes(e.raw_parts[1])){const t=e.kernel.get_window_manager();if(!t)return[];const r=t.get_all_windows().map((e=>e.id.toString()));return ee(r)(e)}return[];default:return[]}},main:async e=>{const{args:t,term:r,kernel:i,shell:n}=e;if(0===t.length)return r.writeln(`${Mt.error}Missing subcommand.`),r.writeln(`Try 'window -h' for more information.${Nt.reset_all}`),1;if(t.includes("-h"))return await i.spawn("help",["window"],n).completion;if(!i.has_window_manager())return r.writeln(`${Mt.error}No window manager found.${Nt.reset_all}`),1;switch(t[0]){case"info":return await(async e=>{const{args:t,term:r,kernel:i}=e;t.shift(),r.write(l);const n=i.get_window_manager(),s=n.get_all_windows(),a=s.filter((e=>e.visible)).length;return r.writeln(`Window manager: ${Et.cyan}${n.get_unique_manager_type_name()}${kt.reset_all}`),r.writeln(`Total open windows: ${Et.cyan}${s.length}${kt.reset_all}`),r.writeln(`Visible windows: ${Et.cyan}${a}${kt.reset_all}`),r.writeln(`Invisible windows: ${Et.cyan}${s.length-a}${kt.reset_all}`),0})(e);case"list":return await(async e=>{const{args:t,term:r,kernel:i}=e;t.shift();let n=!1,s=!1;"-v"===t[0]?(n=!0,t.shift()):"-i"===t[0]&&(s=!0,t.shift()),r.write(l);const a=i.get_window_manager().get_all_windows();for(const e of a){if(n&&!e.visible)continue;if(s&&e.visible)continue;const t=e.visible?`${xt.green}Visible${Ft.reset_all}`:`${xt.red}Invisible${Ft.reset_all}`;r.writeln(`- [${e.id}] ${xt.cyan}${e.title}${Ft.reset_all} : ${t} owned by PID ${xt.yellow}${e.owner_pid}${Ft.reset_all}`)}return 0})(e);case"show":return await(async e=>{const{args:t,term:r,kernel:i}=e;if(t.shift(),0===t.length)return r.writeln(`${At.error}Missing window ID.`),r.writeln(`Try 'window -h' for more information.${St.reset_all}`),1;const n=parseInt(t[0],10);if(isNaN(n))return r.writeln(`${At.error}Invalid window ID '${t[0]}'. Window ID must be an integer.`),r.writeln(`Try 'window list' to see all open windows.${St.reset_all}`),1;if(!i.get_window_manager().get_window_by_id(n))return r.writeln(`${At.error}No window found with ID '${n}'.`),r.writeln(`Try 'window list' to see all open windows.${St.reset_all}`),1;const s=await i.request_privilege("Access the window manager to show a window.");if(!s)return r.writeln(`${At.error}Permission denied to access the window manager.${St.reset_all}`),1;const a=s.get_window_manager().get_window_by_id(n);return a?a.visible?(r.writeln(`Window with ID ${Dt.cyan}${n}${St.reset_all} is already visible.${St.reset_all}`),2):(r.writeln(`Showing window with ID ${Dt.cyan}${n}${St.reset_all}.`),a.show(),0):(r.writeln(`${At.error}No window found with ID '${n}'.`),r.writeln(`Try 'window list' to see all open windows.${St.reset_all}`),1)})(e);case"hide":return await(async e=>{const{args:t,term:r,kernel:i}=e;if(t.shift(),0===t.length)return r.writeln(`${Ot.error}Missing window ID.`),r.writeln(`Try 'window -h' for more information.${Tt.reset_all}`),1;const n=parseInt(t[0],10);if(isNaN(n))return r.writeln(`${Ot.error}Invalid window ID '${t[0]}'. Window ID must be an integer.`),r.writeln(`Try 'window list' to see all open windows.${Tt.reset_all}`),1;if(!i.get_window_manager().get_window_by_id(n))return r.writeln(`${Ot.error}No window found with ID '${n}'.`),r.writeln(`Try 'window list' to see all open windows.${Tt.reset_all}`),1;const s=await i.request_privilege("Access the window manager to hide a window.");if(!s)return r.writeln(`${Ot.error}Permission denied to access the window manager.${Tt.reset_all}`),1;const a=s.get_window_manager().get_window_by_id(n);return a?a.visible?(r.writeln(`Hiding window with ID ${It.cyan}${n}${Tt.reset_all}.`),a.hide(),0):(r.writeln(`Window with ID ${It.cyan}${n}${Tt.reset_all} is already hidden.${Tt.reset_all}`),2):(r.writeln(`${Ot.error}No window found with ID '${n}'.`),r.writeln(`Try 'window list' to see all open windows.${Tt.reset_all}`),1)})(e);case"close":return await(async e=>{const{args:t,term:r,kernel:i}=e;if(t.shift(),0===t.length)return r.writeln(`${Pt.error}Missing window ID.`),r.writeln(`Try 'window -h' for more information.${Ct.reset_all}`),1;const n=parseInt(t[0],10);if(isNaN(n))return r.writeln(`${Pt.error}Invalid window ID '${t[0]}'. Window ID must be an integer.`),r.writeln(`Try 'window list' to see all open windows.${Ct.reset_all}`),1;if(!i.get_window_manager().get_window_by_id(n))return r.writeln(`${Pt.error}No window found with ID '${n}'.`),r.writeln(`Try 'window list' to see all open windows.${Ct.reset_all}`),1;const s=await i.request_privilege("Access the window manager to close a window.");if(!s)return r.writeln(`${Pt.error}Permission denied to access the window manager.${Ct.reset_all}`),1;const a=s.get_window_manager().get_window_by_id(n);return a?(r.writeln(`Closing window with ID ${Bt.cyan}${n}${Ct.reset_all}. The process that opened this window may still be running.`),a.close(),0):(r.writeln(`${Pt.error}No window found with ID '${n}'.`),r.writeln(`Try 'window list' to see all open windows.${Ct.reset_all}`),1)})(e);case"center":return await(async e=>{const{args:t,term:r,kernel:i}=e;if(t.shift(),0===t.length)return r.writeln(`${jt.error}Missing window ID.`),r.writeln(`Try 'window -h' for more information.${Rt.reset_all}`),1;const n=parseInt(t[0],10);if(isNaN(n))return r.writeln(`${jt.error}Invalid window ID '${t[0]}'. Window ID must be an integer.`),r.writeln(`Try 'window list' to see all open windows.${Rt.reset_all}`),1;if(!i.get_window_manager().get_window_by_id(n))return r.writeln(`${jt.error}No window found with ID '${n}'.`),r.writeln(`Try 'window list' to see all open windows.${Rt.reset_all}`),1;const s=await i.request_privilege("Access the window manager to center a window.");if(!s)return r.writeln(`${jt.error}Permission denied to access the window manager.${Rt.reset_all}`),1;const a=s.get_window_manager().get_window_by_id(n);return a?(r.writeln(`Centering window with ID ${Lt.cyan}${n}${Rt.reset_all}.`),a.center(),0):(r.writeln(`${jt.error}No window found with ID '${n}'.`),r.writeln(`Try 'window list' to see all open windows.${Rt.reset_all}`),1)})(e);default:return r.writeln(`${Mt.error}Invalid subcommand.`),r.writeln(`Try 'window -h' for more information.${Nt.reset_all}`),1}}},Gt={name:"alias",description:"Define or display aliases. (Use .ollierc to persist aliases)",usage_suffix:"[name[=value] ...]",arg_descriptions:{name:"The name of the alias to define or display. If no arguments are given, all aliases are displayed. Multiple alias arguments can be provided.","name=value":"Defines an alias with the given name and value. End the value with a space to allow chaining."},compat:"2.0.0",completion:async()=>[],main:async e=>{const{shell:t,term:r}=e;if(!t)return r.writeln("No shell available"),1;const{STYLE:i,PREFABS:n}=r.ansi;if(0===e.args.length){const e=t.memory.list_aliases();for(const[t,i]of e.entries())r.writeln(`alias ${t}='${i}'`);return 0}for(const s of e.args)if(s.includes("=")){const[e,...r]=s.split("=");let i=r.join("=");(i.startsWith("'")&&i.endsWith("'")||i.startsWith('"')&&i.endsWith('"'))&&(i=i.slice(1,-1)),t.memory.set_alias(e,i)}else{const e=t.memory.get_alias(s);e?r.writeln(`alias ${s}='${e}'`):r.writeln(`${n.error}alias: ${s}: not found${i.reset_all}`)}return 0}},Ut={name:"unalias",description:"Remove defined aliases.",usage_suffix:"name [name ...]",arg_descriptions:{name:"The name of the alias to remove. Multiple alias names can be provided."},compat:"2.0.0",completion:async e=>e.shell?[...e.shell.memory.list_aliases().keys()].filter((t=>t.startsWith(e.current_partial))):[],main:async e=>{const{shell:t,term:r}=e;if(!t)return r.writeln("No shell available"),1;const{STYLE:i,PREFABS:n}=r.ansi;if(0===e.args.length)return r.writeln(`${n.error}unalias: usage: unalias name [name ...]${i.reset_all}`),1;for(const s of e.args)t.memory.unset_alias(s)||r.writeln(`${n.error}unalias: ${s}: not found${i.reset_all}`);return 0}},Wt={name:"ps",description:"Display currently running processes.",usage_suffix:"[-p PID]",arg_descriptions:{"Arguments:":{"-p PID":"Display information about the process with the given PID. If omitted, displays all running processes."}},compat:"2.0.0",completion:async e=>{if(console.log(e),0===e.arg_index)return ee(["-p"])(e);if(1===e.arg_index&&"-p"===e.args[0]){const t=e.kernel.get_process_manager().list_pids().map((e=>e.toString()));return ee(t)(e)}return[]},main:async e=>{const{kernel:t,term:r}=e,{STYLE:i,PREFABS:n}=g,s=t.get_process_manager();if("-p"===e.args[0]){const t=parseInt(e.args[1]);if(isNaN(t))return r.writeln(`${n.error}Invalid PID provided.${i.reset_all}`),1;const a=s.get_process(t);return a?(r.write(l),r.writeln(`${i.bold}PID:${i.no_bold_or_dim} ${a.pid}${i.reset_all}`),r.writeln(`${i.bold}Command:${i.no_bold_or_dim} ${a.source_command.command}${i.reset_all}`),r.writeln(`${i.bold}Created:${i.no_bold_or_dim} ${a.created_at.toLocaleString()}${i.reset_all}`),0):(r.writeln(`${n.error}No process found with PID ${t}.${i.reset_all}`),1)}const a=s.list_pids();let o=7;for(const e of a){const t=s.get_process(e);t.source_command.command.length>o&&(o=t.source_command.command.length)}const c=(e=0)=>" ".repeat(o-e);r.write(l),r.writeln(`${i.bold}PID\tCOMMAND${c(7)}\t\tCREATED${i.reset_all}`);for(const e of a){const t=s.get_process(e);r.writeln(`${e}\t${t.source_command.command}${c(t.source_command.command.length)}\t\t${t.created_at.toLocaleString()}`)}return 0}},Ht={name:"kill",description:"Kill a process by its PID.",usage_suffix:"PID",arg_descriptions:{"Arguments:":{PID:"The PID of the process to kill."}},compat:"2.0.0",completion:async e=>{if(0===e.arg_index){const t=e.kernel.get_process_manager().list_pids().map((e=>e.toString()));return ee(t)(e)}return[]},main:async e=>{const{kernel:t,term:r}=e,{STYLE:i,PREFABS:n}=g;if(1!==e.args.length)return r.writeln(`${n.error}Exactly one argument (PID) expected.${i.reset_all}`),1;const s=t.get_process_manager(),a=parseInt(e.args[0]);return isNaN(a)?(r.writeln(`${n.error}Invalid PID provided.${i.reset_all}`),1):(s.kill(a,143),0)}},{STYLE:Jt,FG:qt,PREFABS:zt}=g,{STYLE:Vt,FG:Xt,PREFABS:Kt}=g,{STYLE:Qt,PREFABS:Zt}=g,er={name:"spark",description:"Manage your system with ignition.",usage_suffix:"[-h] [subcommand] [arguments]",arg_descriptions:{"Subcommands:":{service:"Manage running services.","reload-services":"Reload the service definition files."},"Arguments:":{"-h":"Displays this help message.","For service:":{action:"The action to perform (start, stop, restart, status).",service_id:"The ID of the service to manage."}}},compat:"2.0.0",completion:async e=>0===e.arg_index?ee(["service"])(e):[],main:async e=>{const{args:t,term:r,kernel:i,shell:n}=e;if(0===t.length)return r.writeln(`${Zt.error}Missing subcommand.`),r.writeln(`Try 'spark -h' for more information.${Qt.reset_all}`),1;if(t.includes("-h"))return await i.spawn("help",["spark"],n).completion;switch(t[0]){case"service":return await(async e=>{const{args:t,term:r,process:i,kernel:n}=e;if(t.shift(),0===t.length)return r.writeln(`${zt.error}Missing action.`),r.writeln(`Try 'spark -h' for more information.${Jt.reset_all}`),1;if(1===t.length)return r.writeln(`${zt.error}Missing service ID.`),r.writeln(`Try 'spark -h' for more information.${Jt.reset_all}`),1;const s=t[0],a=t[1],o=n.get_ipc(),c=o.create_channel("init");if(!c)return r.writeln(`${zt.error}Failed to communicate with ignition.${Jt.reset_all}`),1;let d,_,u=0;return o.channel_listen(c,(async e=>{const t=e.data;"data"===t.type?d?d(t.data):r.writeln(`${qt.yellow}Warning: Unhandled data response: ${JSON.stringify(t.data)}${Jt.reset_all}`):"response"===t.type?r.writeln(`${qt.green}${t.message}${Jt.reset_all}`):"error"===t.type&&(r.writeln(`${zt.error}${t.message}${Jt.reset_all}`),u=1),_&&i.cancel_timeout(_)})),"status"===s&&(d=e=>{const t=e;switch(r.write(l),r.writeln(`${qt.cyan}Service ID:${Jt.reset_all} ${a}`),r.write(`${qt.cyan}Status: ${Jt.reset_all}`),t.state){case"running":r.writeln(`${qt.green}Running${Jt.reset_all}`),r.writeln(`${qt.cyan}PID:${Jt.reset_all} ${t.pid}`);break;case"stopped":r.writeln(`${qt.yellow}Stopped${Jt.reset_all}`);break;case"failed":r.writeln(`${qt.red}Failed${Jt.reset_all}`)}}),_=i.create_timeout((()=>{}),3e3),o.channel_send(c,{type:"service",action:s,service_id:a}),i.has_timeout(_)&&await i.wait_for_timeout(_)?(r.writeln(`${zt.error}No response from ignition.${Jt.reset_all}`),2):u})(e);case"reload-services":return await(async e=>{const{args:t,term:r,process:i,kernel:n}=e;t.shift();const s=n.get_ipc(),a=s.create_channel("init");if(!a)return r.writeln(`${Kt.error}Failed to communicate with ignition.${Vt.reset_all}`),1;let o,l=0;return s.channel_listen(a,(async e=>{const t=e.data;"response"===t.type?r.writeln(`${Xt.green}${t.message}${Vt.reset_all}`):"error"===t.type&&(r.writeln(`${Kt.error}${t.message}${Vt.reset_all}`),l=1),o&&i.cancel_timeout(o)})),o=i.create_timeout((()=>{}),3e3),s.channel_send(a,{type:"reload_services"}),i.has_timeout(o)&&await i.wait_for_timeout(o)?(r.writeln(`${Kt.error}No response from ignition.${Vt.reset_all}`),2):l})(e);default:return r.writeln(`${Zt.error}Invalid subcommand.`),r.writeln(`Try 'spark -h' for more information.${Qt.reset_all}`),1}return 0}},tr={name:"ipc_bg_test",description:"",usage_suffix:"",arg_descriptions:{},hide_from_help:!0,compat:"2.0.0",completion:async()=>[],main:async e=>{const{kernel:t,term:r,process:i}=e;i.detach();const n=t.get_ipc();return n.service_register("ipc_bg_test",(async(e,t)=>{n.channel_listen(e,(async t=>{r.writeln(`Received message on channel ${e} from PID ${t.from}: ${JSON.stringify(t.data)}`)}))})),r.writeln("ipc_bg_test service started and listening for messages."),0}},rr={name:"ipc_fg_test",description:"",usage_suffix:"",arg_descriptions:{},hide_from_help:!0,compat:"2.0.0",completion:async()=>[],main:async e=>{const{kernel:t,term:r}=e,i=t.get_ipc(),n=i.create_channel("ipc_bg_test");return n?(i.channel_send(n,{message:"Hello from ipc_fg_test!"}),0):(r.writeln("Failed to create IPC channel to service 'ipc_bg_test'."),1)}},ir={name:"taskbar_test",description:"",usage_suffix:"",arg_descriptions:{},compat:"2.0.0",hide_from_help:!0,completion:async()=>[],main:async e=>{const{kernel:t,term:r,process:i,shell:n}=e;if(!t.has_window_manager())return r.writeln("This program requires a window manager."),1;const s=i.create_window();s.title="Taskbar",s.set_custom_flag("no-top-bar",!0),s.x="0vw",s.y="92.5vh",s.height="7.5vh",s.width="100vw";const a=document.createElement("div");a.style.display="flex",a.style.height="100%",a.style.alignItems="center",a.style.gap="1vh",a.style.padding="0 1vh",s.dom.appendChild(a);const o=document.createElement("button");if(o.innerText="FSEdit",o.style.height="100%",o.style.fontSize="2vh",o.onclick=()=>{t.spawn("fsedit",[],n)},a.appendChild(o),t.get_program_registry().getProgram("minecraft")){const e=document.createElement("button");e.style.height="100%",e.style.fontSize="2vh",e.onclick=()=>{t.spawn("minecraft",[],n)};const r=document.createElement("img");r.src="https://brandlogos.net/wp-content/uploads/2022/07/minecraft-logo_brandlogos.net_faqdi-512x560.png",r.style.height="100%",r.style.objectFit="contain",r.alt="Minecraft",r.draggable=!1,e.appendChild(r),a.appendChild(e)}return s.show(),i.detach(),0}},nr={name:"trigger_create_trigger",description:"A trigger to create another trigger. Use this trigger to deploy custom triggers!",usage_suffix:"pkg_name pkg_version trigger_file",arg_descriptions:{"Arguments:":{pkg_name:"The name of the package creating the trigger, which will namespace the trigger. Passed automatically by the package manager.",pkg_version:"Ignored. Passed automatically by the package manager.",trigger_file:"The path to the trigger file to create. This is the string that you pass into the create_trigger trigger in your package's meta.json triggers section."}},hide_from_help:!0,compat:"2.0.0",completion:async()=>[],main:async e=>{const{kernel:t,args:r,term:i}=e;if(3!==r.length)return i.writeln("Usage: trigger_create_trigger pkg_name pkg_version trigger_file"),1;const n=t.get_fs(),s=r[0],a=JSON.parse(r[2]);if(!a.endsWith(".json"))return i.writeln("Error: Trigger file must end with .json"),1;const o=n.join("/usr/bin",s,a);if(!await n.exists(o))return i.writeln(`Error: Trigger file not found at ${o}`),1;const l=n.join("/var/lib/pkg/triggers",s,a);if(await n.exists(l))return i.writeln(`Error: Trigger file already exists at ${l}.`),1;const c=await n.read_file(o);return await n.write_file(l,c),i.writeln(`Trigger created at ${l}`),0}},sr={name:"trigger_remove_trigger",description:"A trigger to remove a trigger.",usage_suffix:"pkg_name pkg_version trigger_file",arg_descriptions:{"Arguments:":{pkg_name:"The name of the package that created the trigger, which is used to namespace the trigger. Passed automatically by the package manager.",pkg_version:"Ignored. Passed automatically by the package manager.",trigger_file:"The path to the trigger file to remove. This is the string that you pass into the create_trigger trigger in your package's meta.json triggers section."}},hide_from_help:!0,compat:"2.0.0",completion:async()=>[],main:async e=>{const{kernel:t,args:r,term:i}=e;if(3!==r.length)return i.writeln("Usage: trigger_remove_trigger pkg_name pkg_version trigger_file"),1;const n=t.get_fs(),s=r[0],a=JSON.parse(r[2]);if(!a.endsWith(".json"))return i.writeln("Error: Trigger file must end with .json"),1;const o=n.join("/var/lib/pkg/triggers",s,a);return await n.exists(o)?(await n.delete_file(o),i.writeln(`Trigger removed from ${o}`),0):0}};class ar extends S{get_unique_fs_type_name(){return"localstorage"}async is_ready(){return!0}async erase_all(){localStorage.removeItem("fs"),localStorage.removeItem("fs_readonly_paths"),localStorage.removeItem("fs_migrations")}async make_dir(e){const t=JSON.parse(localStorage.getItem("fs"));let r=t;const i=e===this._root?[""]:e.split("/");for(const e of i){const t=i.slice(0,i.indexOf(e)+1).join("/");r[e]||(r[e]={},this._call_callbacks(x.MADE_DIR,t)),r=r[e]}localStorage.setItem("fs",JSON.stringify(t))}async delete_dir_direct(e,t){const r=JSON.parse(localStorage.getItem("fs"));let i=r;const n=e===this._root?[""]:e.split("/");for(let e=0;e<n.length;e++){const r=n[e],s=n.slice(0,n.indexOf(r)+1).join("/");if(!t&&(await this.list_dir(s)).length>0)throw new k(r);if(!i[r])throw new v(s);e===n.length-1&&(delete i[r],this._call_callbacks(x.DELETED_DIR,s)),i=i[r]}localStorage.setItem("fs",JSON.stringify(r))}async move_dir_direct(e,t,r){const i=JSON.parse(localStorage.getItem("fs")||"{}"),n=(e=>{const t=e.split("/").filter((e=>e.length>0)),r=t[t.length-1];let n=i;for(let r=0;r<t.length-1;r++){const i=t[r];if(!n[i]||"object"!=typeof n[i])throw new Error(`Path not found: ${e}`);n=n[i]}return{parent:n,basename:r,value:n[r]}})(e);if(!n.value)throw new v(e);if("object"!=typeof n.value)throw new v(e);const s=t.split("/").filter((e=>e.length>0)),a=s[s.length-1];let o,l,c=!1,d=!1,_=i;for(let e=0;e<s.length-1;e++){const r=s[e];if(!_[r]||"object"!=typeof _[r])throw new Error(`Destination parent path not found: ${t}`);_=_[r]}if(_[a]&&(c=!0,d="object"==typeof _[a]),r||c&&d){if(!c)throw new Error(`Destination directory not found: ${t}`);o=_[a],l=n.basename}else{if(c&&!d)throw new Error(`Cannot overwrite non-directory '${t}' with directory.`);o=_,l=a}if(o[l])throw new Error(`Directory not empty: ${l} already exists in destination.`);o[l]=n.value,delete n.parent[n.basename],localStorage.setItem("fs",JSON.stringify(i))}async list_dir(e,t=!1){this._call_callbacks(x.LISTING_DIR,e);const r=JSON.parse(localStorage.getItem("fs"));let i=r;const n=e===this._root?[""]:e.split("/");""===n[n.length-1]&&n.pop();for(const t of n){if(!i[t])throw new v(e);i=i[t]}0===n.length&&(i=r[""]);const s=Object.keys(i);if(t)for(const e of s)"object"==typeof i[e]&&(s.splice(s.indexOf(e),1),s.unshift(e));return s}async read_file_direct(e,t=!1){const r=JSON.parse(localStorage.getItem("fs")),i=e===this._root?[""]:e.split("/");let n=r;for(const t of i){if(i.indexOf(t)!==i.length-1&&!n[t])throw new v(e);n=n[t]}if(void 0!==n){if(0===n.length)return t?new Uint8Array:"";const e=atob(n),r=Uint8Array.from(e,(e=>e.charCodeAt(0)));return t?r:(new TextDecoder).decode(r)}throw new v(e)}async write_file_direct(e,t){let r;"string"==typeof t&&(r=(new TextEncoder).encode(t)),t instanceof ArrayBuffer&&(r=new Uint8Array(t)),t instanceof Uint8Array&&(r=t);const i=JSON.parse(localStorage.getItem("fs"));let n=i;const s=e===this._root?[""]:e.split("/"),a=s[s.length-1];for(const t of s)if(s.indexOf(t)!==s.length-1){if(!n[t])throw new v(e);n=n[t]}n[a]=btoa(String.fromCharCode.apply(null,r)),localStorage.setItem("fs",JSON.stringify(i))}async delete_file_direct(e){const t=JSON.parse(localStorage.getItem("fs"));let r=t;const i=e===this._root?[""]:e.split("/"),n=i[i.length-1];for(const t of i)if(i.indexOf(t)!==i.length-1){if(!r[t])throw new v(e);r=r[t]}delete r[n],localStorage.setItem("fs",JSON.stringify(t));const s=JSON.parse(localStorage.getItem("fs_readonly_paths"));s.includes(e)&&(s.splice(s.indexOf(e),1),localStorage.setItem("fs_readonly_paths",JSON.stringify(s)))}async move_file_direct(e,t){const r=JSON.parse(localStorage.getItem("fs")),i=e===this._root?[""]:e.split("/"),n=t===this._root?[""]:t.split("/"),s=i[i.length-1],a=n[n.length-1];let o=r;for(const t of i.slice(0,-1)){if(!o[t])throw new v(e);o=o[t]}if(void 0===o[s])throw new v(e);let l=r;for(const e of n.slice(0,-1)){if(!l[e])throw new v(t);l=l[e]}if(s===a&&o===l)return void console.warn("source and destination are the same");l[a]=o[s],delete o[s],localStorage.setItem("fs",JSON.stringify(r));const c=JSON.parse(localStorage.getItem("fs_readonly_paths"));c.includes(e)&&(c.splice(c.indexOf(e),1),c.push(t),localStorage.setItem("fs_readonly_paths",JSON.stringify(c)))}async set_readonly_direct(e,t){const r=JSON.parse(localStorage.getItem("fs_readonly_paths"));t&&!r.includes(e)?r.push(e):!t&&r.includes(e)&&r.splice(r.indexOf(e),1),localStorage.setItem("fs_readonly_paths",JSON.stringify(r))}async is_readonly_direct(e){return JSON.parse(localStorage.getItem("fs_readonly_paths")).includes(e)}async exists_direct(e){let t=JSON.parse(localStorage.getItem("fs"));const r=e===this._root?[""]:e.split("/");""===r[r.length-1]&&r.pop();for(const e of r){if(void 0===t[e])return!1;t=t[e]}return!0}async dir_exists(e){let t=JSON.parse(localStorage.getItem("fs"));e.endsWith("/")&&(e=e.slice(0,-1));const r=e===this._root?[""]:e.split("/");for(const e of r){if(!t[e])return!1;t=t[e]}return"object"==typeof t}constructor(){super(),localStorage.getItem("fs")||localStorage.setItem("fs",JSON.stringify({})),localStorage.getItem("fs_readonly_paths")||localStorage.setItem("fs_readonly_paths",JSON.stringify([])),localStorage.getItem("fs_migrations")||localStorage.setItem("fs_migrations",JSON.stringify({string_to_array:!1,array_to_b64:!1}));const e=JSON.parse(localStorage.getItem("fs_migrations"));e.string_to_array||or(JSON.parse(localStorage.getItem("fs")),!0),e.array_to_b64||lr(JSON.parse(localStorage.getItem("fs"))),e.string_to_array=!0,e.array_to_b64=!0,localStorage.setItem("fs_migrations",JSON.stringify(e)),this.make_dir(this._home).then((()=>{this._initialised=!0})).catch((e=>{console.error("Failed to create home directory:",e)}))}}const or=(e,t=!1)=>{for(const t of Object.keys(e))"object"!=typeof e[t]||Array.isArray(e[t])?"string"==typeof e[t]&&(console.log(`Migration: converting ${t} to array`),e[t]=e[t].split(",").map((e=>parseInt(e)))):or(e[t]);t&&localStorage.setItem("fs",JSON.stringify(e))},lr=e=>{const t=[e];for(;t.length>0;){const e=t.pop();if(null!==e&&"object"==typeof e&&!Array.isArray(e))for(const r of Object.keys(e)){const i=e[r];if(i)if("object"!=typeof i||Array.isArray(i)){if(Array.isArray(i)){console.log(`Migration: converting ${r} to b64 string`);try{const t=i.map((e=>parseInt(e))),n=new Uint8Array(t);e[r]=btoa(String.fromCharCode.apply(null,n))}catch(e){console.error(`Migration failed for key "${r}":`,e)}}}else t.push(i)}}localStorage.setItem("fs",JSON.stringify(e))};class cr extends S{_opfs_handle=null;get_unique_fs_type_name(){return"opfs"}constructor(){super(),localStorage.getItem("fs_readonly_paths")||localStorage.setItem("fs_readonly_paths",JSON.stringify([])),navigator.storage.getDirectory().then((e=>{this._opfs_handle=e,this._initialised=!0})).catch((e=>{console.error("Failed to get OPFS directory handle:",e)}))}async is_ready(){return null!==this._opfs_handle}get_root_handle(){if(!this._opfs_handle)throw new Error("OPFS directory handle is not initialised.");return this._opfs_handle}async make_dir(e){const t=this.get_root_handle(),r=e.split("/").filter((e=>e.length>0));let i=t;for(const e of r)i=await i.getDirectoryHandle(e,{create:!0})}async dir_exists(e){const t=this.get_root_handle(),r=e.split("/").filter((e=>e.length>0));let i=t;for(const e of r)try{i=await i.getDirectoryHandle(e)}catch(e){if(e instanceof DOMException&&("NotFoundError"===e.name||"TypeMismatchError"===e.name))return!1;throw e}return!0}async exists_direct(e){const t=this.get_root_handle(),r=e.split("/").filter((e=>e.length>0));let i=t;for(const e of r)try{i=await i.getDirectoryHandle(e)}catch(t){try{return await i.getFileHandle(e),!0}catch(e){if(e instanceof DOMException&&"NotFoundError"===e.name)return!1;throw e}}return!0}async delete_dir_direct(e,t){const r=this.get_root_handle(),i=e.split("/").filter((e=>e.length>0));try{let e=r;for(let t=0;t<i.length-1;t++)e=await e.getDirectoryHandle(i[t]);await e.removeEntry(i[i.length-1],{recursive:t})}catch(r){if(r instanceof DOMException&&"NotFoundError"===r.name)throw new v(e);if(r instanceof DOMException&&"InvalidModificationError"===r.name&&!t)throw new k(e);throw r}}async list_dir(e){const t=this.get_root_handle(),r=e.split("/").filter((e=>e.length>0));let i=t;for(const t of r)try{i=await i.getDirectoryHandle(t)}catch(t){if(t instanceof DOMException&&"NotFoundError"===t.name)throw new v(e);throw t}const n=[];for await(const[e,t]of i.entries())n.push(e);return n}async is_readonly_direct(e){return JSON.parse(localStorage.getItem("fs_readonly_paths")||"[]").includes(e)}async set_readonly_direct(e,t){const r=JSON.parse(localStorage.getItem("fs_readonly_paths")||"[]");t?r.includes(e)||r.push(e):r.includes(e)&&r.splice(r.indexOf(e),1),localStorage.setItem("fs_readonly_paths",JSON.stringify(r))}async move_dir_direct(e,t,r){const i=this.get_root_handle(),n=e.split("/").filter((e=>e.length>0)),s=t.split("/").filter((e=>e.length>0)),a=n[n.length-1],o=s[s.length-1];let l,c=i;for(let t=0;t<n.length-1;t++)try{c=await c.getDirectoryHandle(n[t])}catch(t){if(t instanceof DOMException&&"NotFoundError"===t.name)throw new v(e);throw t}try{l=await c.getDirectoryHandle(a)}catch(t){if(t instanceof DOMException&&"NotFoundError"===t.name)throw new v(e);throw t}let d=i;for(let e=0;e<s.length-1;e++)try{d=await d.getDirectoryHandle(s[e])}catch(e){if(e instanceof DOMException&&"NotFoundError"===e.name)throw new v(t);throw e}let _,u,w=null;try{w=await d.getDirectoryHandle(o)}catch(e){if(e instanceof DOMException&&"NotFoundError"!==e.name)throw e}if(w||r){if(!w)throw new v(t);_=w,u=a}else _=d,u=o;try{throw await _.getDirectoryHandle(u),new E(t)}catch(e){if(e instanceof DOMException&&"NotFoundError"!==e.name)throw e}if("move"in l)await l.move(_,u);else{const e=await _.getDirectoryHandle(u,{create:!0});await this.#X(l,e),await c.removeEntry(a,{recursive:!0})}}async#X(e,t){for await(const[r,i]of e.entries())if("file"===i.kind){const i=await e.getFileHandle(r),n=await i.getFile(),s=await n.arrayBuffer(),a=await t.getFileHandle(r,{create:!0}),o=await a.createWritable();await o.write(s),await o.close()}else if("directory"===i.kind){const i=await e.getDirectoryHandle(r),n=await t.getDirectoryHandle(r,{create:!0});await this.#X(i,n)}}async read_file_direct(e,t){const r=this.get_root_handle(),i=e.split("/").filter((e=>e.length>0));let n,s=r;for(let t=0;t<i.length-1;t++)try{s=await s.getDirectoryHandle(i[t])}catch(t){if(t instanceof DOMException&&"NotFoundError"===t.name)throw new v(e);throw t}try{n=await s.getFileHandle(i[i.length-1])}catch(t){if(t instanceof DOMException&&"NotFoundError"===t.name)throw new v(e);throw t}const a=await n.getFile(),o=await a.arrayBuffer();return t?new Uint8Array(o):(new TextDecoder).decode(o)}async write_file_direct(e,t){const r=this.get_root_handle(),i=e.split("/").filter((e=>e.length>0));let n=r;for(let e=0;e<i.length-1;e++)n=await n.getDirectoryHandle(i[e],{create:!0});const s=await n.getFileHandle(i[i.length-1],{create:!0}),a=await s.createWritable(),o=t instanceof Uint8Array?t:(new TextEncoder).encode(t);await a.write(o.buffer),await a.close()}async delete_file_direct(e){const t=this.get_root_handle(),r=e.split("/").filter((e=>e.length>0));let i=t;for(let t=0;t<r.length-1;t++)try{i=await i.getDirectoryHandle(r[t])}catch(t){if(t instanceof DOMException&&"NotFoundError"===t.name)throw new v(e);throw t}try{await i.removeEntry(r[r.length-1])}catch(t){if(t instanceof DOMException&&"NotFoundError"===t.name)throw new v(e);throw t}const n=JSON.parse(localStorage.getItem("fs_readonly_paths"));n.includes(e)&&(n.splice(n.indexOf(e),1),localStorage.setItem("fs_readonly_paths",JSON.stringify(n)))}async move_file_direct(e,t){const r=this.get_root_handle(),i=e.split("/").filter((e=>e.length>0)),n=t.split("/").filter((e=>e.length>0));let s,a=r;for(let t=0;t<i.length-1;t++)try{a=await a.getDirectoryHandle(i[t])}catch(t){if(t instanceof DOMException&&"NotFoundError"===t.name)throw new v(e);throw t}try{s=await a.getFileHandle(i[i.length-1])}catch(t){if(t instanceof DOMException&&"NotFoundError"===t.name)throw new v(e);throw t}const o=await s.getFile(),l=await o.arrayBuffer();a=r;for(let e=0;e<n.length-1;e++)a=await a.getDirectoryHandle(n[e],{create:!0});const c=await a.getFileHandle(n[n.length-1],{create:!0}),d=await c.createWritable();await d.write(l),await d.close(),await this.delete_file_direct(e)}async erase_all(){const e=this.get_root_handle();for await(const[t,r]of e.entries())"file"===r.kind?await e.removeEntry(t):"directory"===r.kind&&await e.removeEntry(t,{recursive:!0});localStorage.removeItem("fs_readonly_paths")}}const dr=async(e,t,r,i,n=null)=>{console.log(`Generating project folder for ${i}...`);const s=e.join(t,i);await e.make_dir(s);const a=`\n${n.name}\n=${"=".repeat(n.name.length)}\n\n${n.primary_language?`Primary Language: ${n.primary_language}\n\n`:""}${n.description}\n${n.live_url?`\nLive URL: ${n.live_url}`:""}${n.repo_url?`\nRepository: ${n.repo_url}`:""}\n`.replace(/\n/g,l).trim();if(await e.write_file(e.join(s,"info.txt"),l+a+l,!0),n.image){const t=/\.([a-zA-Z0-9]+)(?:\?|$)/,r=n.image.match(t),a=r?r[1]:"png";if(a){const t=e.join(s,`image.${a}`);let r;try{const i=!await e.exists(t);r=await(async(e,t)=>{const r=localStorage.getItem("fetch_ttl_cache"),i=r?JSON.parse(r):{};if(!t&&i[e]&&i[e]>Date.now())return null;const n=await fetch(e),s=await n.arrayBuffer();return i[e]=Date.now()+6048e5,localStorage.setItem("fetch_ttl_cache",JSON.stringify(i)),new Uint8Array(s)})(n.image,i),r&&await e.write_file(t,r,!0)}catch(e){console.error(`Failed to fetch image for project ${i}:`),console.error(e)}}else console.warn(`Project image for ${i} has unsupported file extension; skipping image.`)}if(console.log(`Project folder for ${i} generated successfully.`),n.sub_projects&&Array.isArray(n.sub_projects))for(const t of n.sub_projects)if(!await dr(e,s,r,t.name,t))return console.error(`Failed to generate sub-project folder for ${t}`),!1;return!0};class _r{_owner_pid;constructor(e){this._owner_pid=e}get owner_pid(){return this._owner_pid}create_userspace_proxy_as_other_window(){const e=this,t=Object.create(null);return Object.defineProperties(t,{id:{get:()=>e.id,enumerable:!0},manager:{get:()=>e.manager.create_userspace_proxy(),enumerable:!0},owner_pid:{get:()=>e.owner_pid,enumerable:!0},title:{get:()=>e.title,enumerable:!0},width:{get:()=>e.width,enumerable:!0},height:{get:()=>e.height,enumerable:!0},x:{get:()=>e.x,enumerable:!0},y:{get:()=>e.y,enumerable:!0},visible:{get:()=>e.visible,enumerable:!0},maximised:{get:()=>e.maximised,enumerable:!0}}),Object.freeze(t)}create_userspace_proxy_as_full_window(){const e=this,t=Object.create(null),r=e.manager.create_userspace_proxy();return Object.defineProperties(t,{id:{get:()=>e.id,enumerable:!0},manager:{get:()=>r,enumerable:!0},owner_pid:{get:()=>e.owner_pid,enumerable:!0},dom:{get:()=>e.dom,enumerable:!0},title:{get:()=>e.title,set:t=>{e.title=t},enumerable:!0},width:{get:()=>e.width,set:t=>{e.width=t},enumerable:!0},height:{get:()=>e.height,set:t=>{e.height=t},enumerable:!0},x:{get:()=>e.x,set:t=>{e.x=t},enumerable:!0},y:{get:()=>e.y,set:t=>{e.y=t},enumerable:!0},visible:{get:()=>e.visible,set:t=>{e.visible=t},enumerable:!0},maximised:{get:()=>e.maximised,enumerable:!0},center:{value:()=>{e.center()},enumerable:!0},focus:{value:()=>{e.focus()},enumerable:!0},show:{value:()=>{e.show()},enumerable:!0},hide:{value:()=>{e.hide()},enumerable:!0},toggle:{value:()=>{e.toggle()},enumerable:!0},close:{value:()=>{e.close()},enumerable:!0},add_event_listener:{value:(t,r)=>{e.add_event_listener(t,r)},enumerable:!0},wait_for_event:{value:t=>e.wait_for_event(t),enumerable:!0}}),Object.freeze(t)}}class ur{create_userspace_proxy(){const e=this,t=Object.create(null);return Object.defineProperties(t,{get_unique_manager_type_name:{value:()=>e.get_unique_manager_type_name(),enumerable:!0},get_all_windows:{value:()=>e.get_all_windows().map((e=>e.create_userspace_proxy_as_other_window())),enumerable:!0},get_window_by_id:{value:t=>{const r=e.get_window_by_id(t);return r?r.create_userspace_proxy_as_other_window():null},enumerable:!0}}),Object.freeze(t)}}class wr extends ur{#K=10;#Q=1;#Z=new Map;#ee;get_unique_manager_type_name(){return"DOM"}get Window(){return this.#ee}get_all_windows=()=>Array.from(this.#Z.values());get_window_by_id=e=>this.#Z.get(e)||null;dispose_all(){for(const e of this.#Z.values())e.dispose();this.#Z.clear()}constructor(){super();const e=this;this.#ee=class extends _r{_manager=e;_window_id;_window_root;_window_top_bar;_window_top_bar_title;_window_top_bar_maximise_button;_content_host;_shadow_dom;_event_listeners=new Map;_title_text="New Window";moveable=!0;resizable=!0;_maximisable=!0;_maximised=!1;_custom_flags=new Set;get manager(){return this._manager}constructor(t){super(t),this._window_id=e.#Q++,this._window_root=document.createElement("div"),this._window_root.classList.add("window"),this._window_root.role="dialog",this._window_root.ariaHidden="true",this._window_root.id=`window-${this._window_id}`,document.body.appendChild(this._window_root),this._window_root.style.zIndex=e.#K.toString(),this._window_root.addEventListener("mousedown",(()=>this.focus()),{capture:!0}),window.addEventListener("blur",(()=>this._handle_window_blur())),this._window_top_bar=document.createElement("div"),this._window_top_bar.classList.add("window-top-bar"),this._window_root.appendChild(this._window_top_bar),this._window_top_bar_title=document.createElement("span"),this._window_top_bar_title.classList.add("window-top-bar-title"),this._window_top_bar_title.innerText=this._title_text,this._window_top_bar_title.id=`${this._window_root.id}-title`,this._window_top_bar.appendChild(this._window_top_bar_title),this._window_root.setAttribute("aria-labelledby",this._window_top_bar_title.id);const r=document.createElement("div");r.classList.add("window-top-bar-controls"),r.addEventListener("mousedown",(e=>e.stopPropagation())),this._window_top_bar.appendChild(r);const i=document.createElement("button");i.title="Minimise window",i.classList.add("window-button","window-minimise-button"),i.innerText="−",i.addEventListener("click",(()=>this.hide())),this._window_top_bar_maximise_button=document.createElement("button"),this._window_top_bar_maximise_button.title="Maximise window",this._window_top_bar_maximise_button.classList.add("window-button","window-maximise-button"),this._window_top_bar_maximise_button.innerText="◻",this._window_top_bar_maximise_button.addEventListener("click",(e=>{this.maximisable&&(this.maximised=!this.maximised)}));const n=document.createElement("button");n.title="Close window",n.classList.add("window-button","window-close-button"),n.innerText="×",n.addEventListener("click",this.close.bind(this)),r.appendChild(i),r.appendChild(this._window_top_bar_maximise_button),r.appendChild(n),this._window_top_bar.addEventListener("mousedown",(e=>this._start_drag(e))),this._content_host=document.createElement("div"),this._content_host.classList.add("window-content-host"),this._shadow_dom=this._content_host.attachShadow({mode:"closed"}),this._window_root.appendChild(this._content_host),e.#Z.set(this._window_id,this)}get id(){return this._window_id}dispose(){this._window_root.remove(),e.#Z.delete(this._window_id)}close(){this._window_root.classList.add("animating-close"),this._window_root.ariaHidden="true",this._emit_event("close"),setTimeout((()=>{this.dispose()}),200)}focus(){this._emit_event("focus"),e.#K+=1,this._window_root.style.zIndex=e.#K.toString()}_handle_window_blur(){setTimeout((()=>{document.activeElement===this._content_host&&this.focus()}),0)}async _emit_event(e){if(!this._event_listeners.has(e))return;const t=this._event_listeners.get(e);await Promise.all(t.map((e=>e())))}_start_drag(e){if(!this.moveable)return;this._content_host.classList.add("dragging"),e.preventDefault();const t=this._window_root.getBoundingClientRect();let r=e.clientX-t.left;const i=e.clientY-t.top,n=e=>{if(e.preventDefault(),this._maximised){this.maximised=!1;const e=this._window_root.getBoundingClientRect(),i=r/t.width;r=e.width*i}this._window_root.style.left=e.clientX-r+"px",this._window_root.style.top=e.clientY-i+"px",this._emit_event("move")},s=e=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s),this._content_host.classList.remove("dragging"),this._maximised||e.clientY<=0&&this._maximisable&&(this.maximised=!0),this._window_root.getBoundingClientRect().top<0&&(this._window_root.style.top="0px")};document.addEventListener("mousemove",n),document.addEventListener("mouseup",s)}add_event_listener(e,t){this._event_listeners.has(e)||this._event_listeners.set(e,[]),this._event_listeners.get(e).push(t)}remove_event_listener(e,t){if(!this._event_listeners.has(e))return;const r=this._event_listeners.get(e),i=r.indexOf(t);-1!==i&&r.splice(i,1)}get title(){return this._title_text}set title(e){this._window_top_bar_title.innerText=e,this._title_text=e,this._emit_event("rename")}get width(){return this._window_root.style.width}set width(e){this._window_root.style.width=e}get height(){return this._window_root.style.height}set height(e){this._window_root.style.height=e}get maximisable(){return this._maximisable}set maximisable(e){this._maximisable=e,this._window_top_bar_maximise_button.disabled=!e}get maximised(){return this._maximised}set maximised(e){this._maximised=e,this._window_root.classList.toggle("maximised",e),e?(this._window_top_bar_maximise_button.innerText="🗗",this._window_top_bar_maximise_button.title="Restore window",this._emit_event("maximise")):(this._window_top_bar_maximise_button.innerText="◻",this._window_top_bar_maximise_button.title="Maximise window",this._emit_event("restore"))}get x(){return this._window_root.style.left}set x(e){"number"==typeof e&&(e=`${e}px`),this._window_root.style.left=e}get y(){return this._window_root.style.top}set y(e){"number"==typeof e&&(e=`${e}px`),this._window_root.style.top=e}center(){this.x=`calc(calc(100vw - ${this.width}) / 2)`,this.y=`calc(calc(100vh - ${this.height}) / 2)`}get dom(){return this._shadow_dom}show(){this._window_root.classList.remove("animating-out"),this._window_root.classList.add("visible","animating-in"),this._window_root.ariaHidden="false",setTimeout((()=>{this._window_root.classList.remove("animating-in")}),200),this._emit_event("show")}hide(){this._window_root.classList.remove("animating-in"),this._window_root.classList.add("animating-out"),this._window_root.ariaHidden="true",setTimeout((()=>{this._window_root.classList.remove("visible","animating-out")}),200),this._emit_event("hide")}toggle(){this._window_root.classList.toggle("visible"),this.visible?this._emit_event("show"):this._emit_event("hide")}get visible(){return this._window_root.classList.contains("visible")}set visible(e){e?this.show():this.hide()}get_custom_flag(e){return this._custom_flags.has(e)}set_custom_flag(e,t){switch(t?this._custom_flags.add(e):this._custom_flags.delete(e),e){case"transparent":t?this._content_host.classList.add("transparent"):this._content_host.classList.remove("transparent");break;case"no-top-bar":t?this._window_top_bar.classList.add("hidden"):this._window_top_bar.classList.remove("hidden")}}wait_for_event(e){return new Promise((t=>{const r=async()=>{this.remove_event_listener(e,r),t()};this.add_event_listener(e,r)}))}}}}globalThis.ollieos={},globalThis.howler=A,globalThis["html-to-text"]=Ce,globalThis.sixel=Fe,globalThis["@xterm/xterm"]=o,globalThis.xterm=o,"undefined"!=typeof window&&(console.log("Loading browser-specific global externals..."),(async()=>{const e=await Promise.resolve().then(r.t.bind(r,616,23)),t=await Promise.resolve().then(r.t.bind(r,832,23)),i=await Promise.resolve().then(r.t.bind(r,292,23)),n=await r.e(882).then(r.bind(r,882)),s=await r.e(465).then(r.t.bind(r,465,23));globalThis["@xterm/addon-fit"]=e,globalThis["@xterm/addon-web-links"]=t,globalThis["@xterm/addon-image"]=i,globalThis["xterm-link-provider"]=n,globalThis.sweetalert2=s,globalThis["xterm-addon-fit"]=e,globalThis["xterm-addon-web-links"]=t,globalThis["xterm-addon-image"]=i,console.log("Browser-specific global externals loaded successfully.")})());const hr=async e=>{const t=new b;for(const e of Object.values(i))await t.registerProgram({program:e,built_in:!0});const r=new T;let o;r.register_file("reader_on","public/sfx/reader_on.mp3"),r.register_file("reader_off","public/sfx/reader_off.mp3"),o=!localStorage.getItem("fs")&&navigator.storage&&"getDirectory"in navigator.storage?new cr:new ar,await o.is_ready()||await new Promise((e=>{const t=setInterval((async()=>{await o.is_ready()&&(clearInterval(t),e())}),10)})),await(async e=>{await(async e=>{const t=e.absolute("/boot");await e.dir_exists(t)||await e.make_dir(t);const r=e.absolute("/boot/init");await e.exists(r)||await e.write_file(r,"ignition");const i=e.absolute("/etc");await e.dir_exists(i)||await e.make_dir(i);const n=e.absolute("/etc/boot_target");await e.exists(n)||await e.write_file(n,"jetty");const s=e.absolute("/etc/default_shell");await e.exists(s)||await e.write_file(s,"ash --login");const a=e.absolute("/sys");await e.dir_exists(a)||await e.make_dir(a);const o=e.absolute("/sys/privilege_agent");await e.exists(o)||await e.write_file(o,"default_privilege_agent")})(e),await(async e=>{const t=e.absolute("/etc");await e.dir_exists(t)||await e.make_dir(t);const r=`┌─ Welcome to ${g.STYLE.italic+g.STYLE.bold+g.FG.magenta}OllieOS...${g.STYLE.reset_all} ───────────────────┐\n│  ${g.STYLE.bold+g.FG.blue}Type ${g.PREFABS.program_name}help${g.STYLE.no_italic+g.FG.blue} for a list of commands.${g.STYLE.reset_all}        │\n│  ${g.STYLE.bold+g.FG.blue}Type ${g.PREFABS.program_name}mefetch${g.STYLE.no_italic+g.FG.blue} for info about me.${g.STYLE.reset_all}          │\n│  ${g.STYLE.bold+g.FG.blue}Type ${g.PREFABS.program_name}cd projects${g.STYLE.no_italic+g.FG.blue} to view project info.${g.STYLE.reset_all}   │\n│  ${g.STYLE.bold+g.FG.blue}Type ${g.PREFABS.program_name}bugreport${g.STYLE.no_italic+g.FG.blue} to open the bug reporter.${g.STYLE.reset_all} │\n└───────────────────────────────────────────┘`.replace(/\n/g,l),i=e.absolute("/etc/motd.txt");await e.exists(i)||await e.write_file(i,r)})(e),await(async e=>{const t=e.absolute("~/.ollie_profile"),r=e.absolute("~/.ash_profile");await e.exists(t)&&!await e.exists(r)&&await e.move_file(t,r);const i=e.absolute("~/.ollierc"),n=e.absolute("~/.ashrc");await e.exists(i)&&!await e.exists(n)&&await e.move_file(i,n)})(e),await(async e=>{const t="\nCredits\n=======\n\nThis website was created by obfuscatedgenerated using the following technologies:\n\n- TypeScript\n- xterm.js\n- Handlebars.js\n- Webpack\n\nAs well as the following libraries:\n\n- imgToAscii (modified)\n- node-sixel\n- @xterm/addon-fit\n- @xterm/addon-web-links\n- @xterm/addon-image\n- xterm-link-provider\n- howler.js\n- html-to-text\n- some code from rss-parser (modified)\n\nPlease consult https://ollieg.codes/public/script/3rdpartylicenses.txt for full license information.\n\nAdditionally, fsedit uses:\n\n- Font Awesome\n\nThe source code is available on GitHub at https://github.com/obfuscatedgenerated/obfuscatedgenerated.github.io.\n".replace(/\n/g,l),r=e.absolute("~/credits.txt");await e.exists(r)&&await e.read_file(r)===t||(await e.write_file(r,t,!0),await e.set_readonly(r,!0))})(e);const t=await(async e=>{console.log("Syncing data repository...");const t=e.absolute("/var/lib/data");let r="";if(await e.dir_exists(t)){const i=e.join(t,"version.json");await e.exists(i)&&(r=JSON.parse(await e.read_file(i)).rev)}else await e.make_dir(t);try{const i=await fetch("https://data.ollieg.codes/version.json").then((e=>e.json())),n=i.rev;if(r===n)return void console.log("Data repository is already up to date.");const s=e.absolute(`/var/lib/.data.old_${r}`);r&&(await e.move_dir(t,s),await e.make_dir(t));const a=await fetch("https://data.ollieg.codes/index.json").then((e=>e.json()));if(!a.groups)throw new Error("Index file is missing 'groups' field.");await e.write_file(e.join(t,"index.json"),JSON.stringify(a,null,2),!0),await e.write_file(e.join(t,"version.json"),JSON.stringify(i,null,2),!0);for(const r of a.groups){console.log(`Syncing data group: ${r}`);const i=e.join(t,r);await e.dir_exists(i)||await e.make_dir(i);const n=await fetch(`https://data.ollieg.codes/${r}/index.json`).then((e=>e.json()));if(!Array.isArray(n))throw new Error(`Group index for ${r} is not an array.`);await e.write_file(e.join(i,"index.json"),JSON.stringify(n,null,2),!0);for(const t of n){console.log(`  Fetching file: ${t}.json`);const n=await fetch(`https://data.ollieg.codes/${r}/${t}.json`).then((e=>e.text())),s=e.join(i,`${t}.json`);await e.write_file(s,n,!0)}}return console.log("Data repository synced successfully."),await e.dir_exists(s)&&await e.delete_dir(s,!0),n}catch(i){console.error("Failed to sync data repository:"),console.error(i);const n=e.absolute(`/var/lib/.data.old_${r}`);await e.dir_exists(n)?(console.error("Restoring backup..."),await e.move_dir(t,e.absolute("/var/lib/data.discard")),await e.move_dir(n,t),await e.delete_dir(e.absolute("/var/lib/data.discard"),!0)):await e.delete_dir(t,!0)}return null})(e);await(async(e,t)=>{if(!t)try{const r=e.absolute("/var/lib/data/version.json");if(!await e.exists(r))throw new Error("Version file does not exist.");t=JSON.parse(await e.read_file(r)).rev}catch(e){console.error("Failed to read data revision from data repository:"),console.error(e),t=null}if(!t)return void console.warn("Data repo not synced; skipping project setup.");const r=e.absolute("~/projects");let i="";if(await e.dir_exists(r)){const t=e.join(r,".rev");await e.exists(t)&&(i=await e.read_file(t))}else await e.make_dir(r);if(i===t)return void console.log("Projects are already up to date.");const n=e.absolute(`~/.projects.old_${i}`);i&&(await e.move_dir(r,n),await e.make_dir(r));try{const i=e.absolute("/var/lib/data/project"),n=e.join(i,"index.json");if(!await e.exists(n))throw new Error("Project index file does not exist in data repository.");const s=JSON.parse(await e.read_file(n));if(!Array.isArray(s))throw new Error("Project index file is not an array.");for(const t of s){console.log(`Setting up project: ${t}`);const n=e.join(i,`${t}.json`);if(!await e.exists(n))return console.warn(`Project file for ${t} does not exist; skipping.`),!1;const s=JSON.parse(await e.read_file(n));if(!await dr(e,r,i,t,s))throw new Error(`Failed to generate project folder for ${t}`)}const a=e.join(r,".rev");await e.write_file(a,t,!0),console.log("Projects set up successfully.")}catch(t){return console.error("Failed to set up projects:"),console.error(t),void(await e.dir_exists(n)?(console.error("Restoring backup..."),await e.move_dir(r,e.absolute("~/projects.discard")),await e.move_dir(n,r),await e.delete_dir(e.absolute("~/projects.discard"),!0)):await e.delete_dir(r,!0))}})(e,t)})(o);const c=new wr,d=new m({screenReaderMode:!1,cursorBlink:!0}),_=new n.FitAddon;d.loadAddon(_),d.loadAddon(new s.WebLinksAddon),d.loadAddon(new a.ImageAddon);const u=document.querySelector("#terminal");if(d.open(u),_.fit(),window.innerWidth<600){const e=d.word_wrap(`${g.BG.red+g.FG.white}Warning: The screen that the terminal is running on is rather small!${l+l}Some programs may not display correctly, consider using a larger screen such as a computer or tablet.${l+l}An alternative interface is in the works. You can also use the command "legacy" to view the old (outdated) site.${g.STYLE.reset_all}`,d.cols);d.writeln(e)}window.addEventListener("keydown",(function(e){"F1"===e.code&&e.preventDefault()})),window.addEventListener("resize",(()=>{_.fit()})),window.addEventListener("contextmenu",(e=>{e.preventDefault(),d.copy_or_paste()}));const w=new j(d,o,t,r,c);return w.set_env_info(document.body.dataset.version,"web"),await w.boot(e)}}}]);